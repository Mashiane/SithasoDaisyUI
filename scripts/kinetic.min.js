var Kinetic={};!function(root){var PI_OVER_180=Math.PI/180;(Kinetic={version:"5.2.0",stages:[],idCounter:0,ids:{},names:{},shapes:{},listenClickTap:!1,inDblClickWindow:!1,enableTrace:!1,traceArrMax:100,dblClickWindow:400,pixelRatio:void 0,dragDistance:0,angleDeg:!0,showWarnings:!0,Filters:{},Node:function(config){this._init(config)},Shape:function(config){this.__init(config)},Container:function(config){this.__init(config)},Stage:function(config){this.___init(config)},BaseLayer:function(config){this.___init(config)},Layer:function(config){this.____init(config)},FastLayer:function(config){this.____init(config)},Group:function(config){this.___init(config)},isDragging:function(){var dd=Kinetic.DD;return!!dd&&dd.isDragging},isDragReady:function(){var dd=Kinetic.DD;return!!dd&&!!dd.node},_addId:function(node,id){void 0!==id&&(this.ids[id]=node)},_removeId:function(id){void 0!==id&&delete this.ids[id]},_addName:function(node,name){if(void 0!==name)for(var names=name.split(/\s/g),n=0;n<names.length;n++){var subname=names[n];subname&&(void 0===this.names[subname]&&(this.names[subname]=[]),this.names[subname].push(node))}},_removeName:function(name,_id){if(void 0!==name){var nodes=this.names[name];if(void 0!==nodes){for(var n=0;n<nodes.length;n++){var no;nodes[n]._id===_id&&nodes.splice(n,1)}0===nodes.length&&delete this.names[name]}}},getAngle:function(angle){return this.angleDeg?angle*PI_OVER_180:angle},_parseUA:function(userAgent){var ua=userAgent.toLowerCase(),match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[],mobile=!!userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i),ieMobile=!!userAgent.match(/IEMobile/i);return{browser:match[1]||"",version:match[2]||"0",mobile:mobile,ieMobile:ieMobile}},UA:void 0}).UA=Kinetic._parseUA(root.navigator&&root.navigator.userAgent||"")}(this),function(root,factory){if("object"==typeof exports){var KineticJS=factory();if(global.window===global)Kinetic.document=global.document,Kinetic.window=global;else{var Canvas=require("canvas"),jsdom=require("jsdom").jsdom;Kinetic.document=jsdom("<!DOCTYPE html><html><head></head><body></body></html>"),Kinetic.window=Kinetic.document.createWindow(),Kinetic.window.Image=Canvas.Image,Kinetic._nodeCanvas=Canvas}return Kinetic.root=root,void(module.exports=KineticJS)}"function"==typeof define&&define.amd&&define(factory),Kinetic.document=document,Kinetic.window=window,Kinetic.root=root}(this,(function(){return Kinetic})),function(){Kinetic.Collection=function(){var args=[].slice.call(arguments),length=args.length,i=0;for(this.length=length;i<length;i++)this[i]=args[i];return this},Kinetic.Collection.prototype=[],Kinetic.Collection.prototype.each=function(func){for(var n=0;n<this.length;n++)func(this[n],n)},Kinetic.Collection.prototype.toArray=function(){var arr=[],len=this.length,n;for(n=0;n<len;n++)arr.push(this[n]);return arr},Kinetic.Collection.toCollection=function(arr){var collection=new Kinetic.Collection,len=arr.length,n;for(n=0;n<len;n++)collection.push(arr[n]);return collection},Kinetic.Collection._mapMethod=function(methodName){Kinetic.Collection.prototype[methodName]=function(){var len=this.length,i,args=[].slice.call(arguments);for(i=0;i<len;i++)this[i][methodName].apply(this[i],args);return this}},Kinetic.Collection.mapMethods=function(constructor){var prot=constructor.prototype;for(var methodName in prot)Kinetic.Collection._mapMethod(methodName)},Kinetic.Transform=function(m){this.m=m&&m.slice()||[1,0,0,1,0,0]},Kinetic.Transform.prototype={copy:function(){return new Kinetic.Transform(this.m)},point:function(point){var m=this.m;return{x:m[0]*point.x+m[2]*point.y+m[4],y:m[1]*point.x+m[3]*point.y+m[5]}},translate:function(x,y){return this.m[4]+=this.m[0]*x+this.m[2]*y,this.m[5]+=this.m[1]*x+this.m[3]*y,this},scale:function(sx,sy){return this.m[0]*=sx,this.m[1]*=sx,this.m[2]*=sy,this.m[3]*=sy,this},rotate:function(rad){var c=Math.cos(rad),s=Math.sin(rad),m11=this.m[0]*c+this.m[2]*s,m12=this.m[1]*c+this.m[3]*s,m21=this.m[0]*-s+this.m[2]*c,m22=this.m[1]*-s+this.m[3]*c;return this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},skew:function(sx,sy){var m11=this.m[0]+this.m[2]*sy,m12=this.m[1]+this.m[3]*sy,m21=this.m[2]+this.m[0]*sx,m22=this.m[3]+this.m[1]*sx;return this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this},multiply:function(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1],m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1],m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3],m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3],dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4],dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];return this.m[0]=m11,this.m[1]=m12,this.m[2]=m21,this.m[3]=m22,this.m[4]=dx,this.m[5]=dy,this},invert:function(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),m0=this.m[3]*d,m1=-this.m[1]*d,m2=-this.m[2]*d,m3=this.m[0]*d,m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=m0,this.m[1]=m1,this.m[2]=m2,this.m[3]=m3,this.m[4]=m4,this.m[5]=m5,this},getMatrix:function(){return this.m},setAbsolutePosition:function(x,y){var m0=this.m[0],m1=this.m[1],m2=this.m[2],m3=this.m[3],m4=this.m[4],m5,yt=(m0*(y-this.m[5])-m1*(x-m4))/(m0*m3-m1*m2),xt=(x-m4-m2*yt)/m0;return this.translate(xt,yt)}};var CONTEXT_2D="2d",OBJECT_ARRAY="[object Array]",OBJECT_NUMBER="[object Number]",OBJECT_STRING="[object String]",PI_OVER_DEG180=Math.PI/180,DEG180_OVER_PI=180/Math.PI,HASH="#",EMPTY_STRING="",ZERO="0",KINETIC_WARNING="Kinetic warning: ",KINETIC_ERROR="Kinetic error: ",RGB_PAREN="rgb(",COLORS={aqua:[0,255,255],lime:[0,255,0],silver:[192,192,192],black:[0,0,0],maroon:[128,0,0],teal:[0,128,128],blue:[0,0,255],navy:[0,0,128],white:[255,255,255],fuchsia:[255,0,255],olive:[128,128,0],yellow:[255,255,0],orange:[255,165,0],gray:[128,128,128],purple:[128,0,128],green:[0,128,0],red:[255,0,0],pink:[255,192,203],cyan:[0,255,255],transparent:[255,255,255,0]},RGB_REGEX=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;Kinetic.Util={_isElement:function(obj){return!(!obj||1!=obj.nodeType)},_isFunction:function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)},_isObject:function(obj){return!!obj&&obj.constructor==Object},_isArray:function(obj){return Object.prototype.toString.call(obj)==OBJECT_ARRAY},_isNumber:function(obj){return Object.prototype.toString.call(obj)==OBJECT_NUMBER},_isString:function(obj){return Object.prototype.toString.call(obj)==OBJECT_STRING},_throttle:function(func,wait,opts){var context,args,result,timeout=null,previous=0,options=opts||{},later=function(){previous=!1===options.leading?0:(new Date).getTime(),timeout=null,result=func.apply(context,args),context=args=null};return function(){var now=(new Date).getTime();previous||!1!==options.leading||(previous=now);var remaining=wait-(now-previous);return context=this,args=arguments,remaining<=0?(clearTimeout(timeout),timeout=null,previous=now,result=func.apply(context,args),context=args=null):timeout||!1===options.trailing||(timeout=setTimeout(later,remaining)),result}},_hasMethods:function(obj){var names=[],key;for(key in obj)this._isFunction(obj[key])&&names.push(key);return names.length>0},createCanvasElement:function(){var canvas=Kinetic.document.createElement("canvas");try{canvas.style=canvas.style||{}}catch(e){}return canvas},isBrowser:function(){return"object"!=typeof exports},_isInDocument:function(el){for(;el=el.parentNode;)if(el==Kinetic.document)return!0;return!1},_simplifyArray:function(arr){var retArr=[],len=arr.length,util=Kinetic.Util,n,val;for(n=0;n<len;n++)val=arr[n],util._isNumber(val)?val=Math.round(1e3*val)/1e3:util._isString(val)||(val=val.toString()),retArr.push(val);return retArr},_getImage:function(arg,callback){var imageObj,canvas;if(arg)if(this._isElement(arg))callback(arg);else if(this._isString(arg))(imageObj=new Kinetic.window.Image).onload=function(){callback(imageObj)},imageObj.src=arg;else if(arg.data){var _context;(canvas=Kinetic.Util.createCanvasElement()).width=arg.width,canvas.height=arg.height,canvas.getContext("2d").putImageData(arg,0,0),this._getImage(canvas.toDataURL(),callback)}else callback(null);else callback(null)},_getRGBAString:function(obj){var red,green,blue,alpha;return["rgba(",obj.red||0,",",obj.green||0,",",obj.blue||0,",",obj.alpha||1,")"].join("")},_rgbToHex:function(r,g,b){return((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)},_hexToRgb:function(hex){hex=hex.replace("#","");var bigint=parseInt(hex,16);return{r:bigint>>16&255,g:bigint>>8&255,b:255&bigint}},getRandomColor:function(){for(var randColor=(16777215*Math.random()<<0).toString(16);randColor.length<6;)randColor="0"+randColor;return"#"+randColor},get:function(val,def){return void 0===val?def:val},getRGB:function(color){var rgb;return color in COLORS?{r:(rgb=COLORS[color])[0],g:rgb[1],b:rgb[2]}:"#"===color[0]?this._hexToRgb(color.substring(1)):"rgb("===color.substr(0,4)?(rgb=RGB_REGEX.exec(color.replace(/ /g,"")),{r:parseInt(rgb[1],10),g:parseInt(rgb[2],10),b:parseInt(rgb[3],10)}):{r:0,g:0,b:0}},_merge:function(o1,o2){var retObj=this._clone(o2);for(var key in o1)this._isObject(o1[key])?retObj[key]=this._merge(o1[key],retObj[key]):retObj[key]=o1[key];return retObj},cloneObject:function(obj){var retObj={};for(var key in obj)this._isObject(obj[key])?retObj[key]=this.cloneObject(obj[key]):this._isArray(obj[key])?retObj[key]=this.cloneArray(obj[key]):retObj[key]=obj[key];return retObj},cloneArray:function(arr){return arr.slice(0)},_degToRad:function(deg){return deg*PI_OVER_DEG180},_radToDeg:function(rad){return rad*DEG180_OVER_PI},_capitalize:function(str){return str.charAt(0).toUpperCase()+str.slice(1)},error:function(str){throw new Error(KINETIC_ERROR+str)},warn:function(str){Kinetic.root.console&&console.warn&&Kinetic.showWarnings&&console.warn(KINETIC_WARNING+str)},extend:function(child,parent){function ctor(){this.constructor=child}ctor.prototype=parent.prototype;var old_proto=child.prototype;for(var key in child.prototype=new ctor,old_proto)old_proto.hasOwnProperty(key)&&(child.prototype[key]=old_proto[key]);child.__super__=parent.prototype},addMethods:function(constructor,methods){var key;for(key in methods)constructor.prototype[key]=methods[key]},_getControlPoints:function(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2)),d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)),fa=t*d01/(d01+d12),fb=t*d12/(d01+d12),p1x,p1y,p2x,p2y;return[x1-fa*(x2-x0),y1-fa*(y2-y0),x1+fb*(x2-x0),y1+fb*(y2-y0)]},_expandPoints:function(p,tension){var len=p.length,allPoints=[],n,cp;for(n=2;n<len-2;n+=2)cp=Kinetic.Util._getControlPoints(p[n-2],p[n-1],p[n],p[n+1],p[n+2],p[n+3],tension),allPoints.push(cp[0]),allPoints.push(cp[1]),allPoints.push(p[n]),allPoints.push(p[n+1]),allPoints.push(cp[2]),allPoints.push(cp[3]);return allPoints},_removeLastLetter:function(str){return str.substring(0,str.length-1)}}}(),function(){var canvas,context=Kinetic.Util.createCanvasElement().getContext("2d"),_pixelRatio=Kinetic.UA.mobile?(window.devicePixelRatio||1)/(context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1):1,devicePixelRatio,backingStoreRatio;Kinetic.Canvas=function(config){this.init(config)},Kinetic.Canvas.prototype={init:function(config){var conf,pixelRatio=(config||{}).pixelRatio||Kinetic.pixelRatio||_pixelRatio;this.pixelRatio=pixelRatio,this._canvas=Kinetic.Util.createCanvasElement(),this._canvas.style.padding=0,this._canvas.style.margin=0,this._canvas.style.border=0,this._canvas.style.background="transparent",this._canvas.style.position="absolute",this._canvas.style.top=0,this._canvas.style.left=0},getContext:function(){return this.context},getPixelRatio:function(){return this.pixelRatio},setPixelRatio:function(pixelRatio){this.pixelRatio=pixelRatio,this.setSize(this.getWidth(),this.getHeight())},setWidth:function(width){this.width=this._canvas.width=width*this.pixelRatio,this._canvas.style.width=width+"px"},setHeight:function(height){this.height=this._canvas.height=height*this.pixelRatio,this._canvas.style.height=height+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(width,height){this.setWidth(width),this.setHeight(height)},toDataURL:function(mimeType,quality){try{return this._canvas.toDataURL(mimeType,quality)}catch(e){try{return this._canvas.toDataURL()}catch(err){return Kinetic.Util.warn("Unable to get data URL. "+err.message),""}}}},Kinetic.SceneCanvas=function(config){var conf=config||{},width=conf.width||0,height=conf.height||0;Kinetic.Canvas.call(this,conf),this.context=new Kinetic.SceneContext(this),this.setSize(width,height)},Kinetic.SceneCanvas.prototype={setWidth:function(width){var pixelRatio=this.pixelRatio,_context=this.getContext()._context;Kinetic.Canvas.prototype.setWidth.call(this,width),_context.scale(pixelRatio,pixelRatio)},setHeight:function(height){var pixelRatio=this.pixelRatio,_context=this.getContext()._context;Kinetic.Canvas.prototype.setHeight.call(this,height),_context.scale(pixelRatio,pixelRatio)}},Kinetic.Util.extend(Kinetic.SceneCanvas,Kinetic.Canvas),Kinetic.HitCanvas=function(config){var conf=config||{},width=conf.width||0,height=conf.height||0;Kinetic.Canvas.call(this,conf),this.context=new Kinetic.HitContext(this),this.setSize(width,height),this.hitCanvas=!0},Kinetic.Util.extend(Kinetic.HitCanvas,Kinetic.Canvas)}(),function(){var COMMA=",",OPEN_PAREN="(",CLOSE_PAREN=")",OPEN_PAREN_BRACKET="([",CLOSE_BRACKET_PAREN="])",SEMICOLON=";",DOUBLE_PAREN="()",EQUALS="=",CONTEXT_METHODS=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createLinearGradient","createPattern","createRadialGradient","drawImage","fill","fillText","getImageData","createImageData","lineTo","moveTo","putImageData","quadraticCurveTo","rect","restore","rotate","save","scale","setLineDash","setTransform","stroke","strokeText","transform","translate"];Kinetic.Context=function(canvas){this.init(canvas)},Kinetic.Context.prototype={init:function(canvas){this.canvas=canvas,this._context=canvas._canvas.getContext("2d"),Kinetic.enableTrace&&(this.traceArr=[],this._enableTrace())},fillShape:function(shape){shape.getFillEnabled()&&this._fill(shape)},strokeShape:function(shape){shape.getStrokeEnabled()&&this._stroke(shape)},fillStrokeShape:function(shape){var fillEnabled;shape.getFillEnabled()&&this._fill(shape),shape.getStrokeEnabled()&&this._stroke(shape)},getTrace:function(relaxed){var traceArr=this.traceArr,len=traceArr.length,str="",n,trace,method,args;for(n=0;n<len;n++)(method=(trace=traceArr[n]).method)?(args=trace.args,str+=method,relaxed?str+="()":Kinetic.Util._isArray(args[0])?str+="(["+args.join(",")+"])":str+="("+args.join(",")+")"):(str+=trace.property,relaxed||(str+="="+trace.val)),str+=";";return str},clearTrace:function(){this.traceArr=[]},_trace:function(str){var traceArr=this.traceArr,len;traceArr.push(str),(len=traceArr.length)>=Kinetic.traceArrMax&&traceArr.shift()},reset:function(){var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(1*pixelRatio,0,0,1*pixelRatio,0,0)},getCanvas:function(){return this.canvas},clear:function(bounds){var canvas=this.getCanvas();bounds?this.clearRect(bounds.x||0,bounds.y||0,bounds.width||0,bounds.height||0):this.clearRect(0,0,canvas.getWidth(),canvas.getHeight())},_applyLineCap:function(shape){var lineCap=shape.getLineCap();lineCap&&this.setAttr("lineCap",lineCap)},_applyOpacity:function(shape){var absOpacity=shape.getAbsoluteOpacity();1!==absOpacity&&this.setAttr("globalAlpha",absOpacity)},_applyLineJoin:function(shape){var lineJoin=shape.getLineJoin();lineJoin&&this.setAttr("lineJoin",lineJoin)},setAttr:function(attr,val){this._context[attr]=val},arc:function(){var a=arguments;this._context.arc(a[0],a[1],a[2],a[3],a[4],a[5])},beginPath:function(){this._context.beginPath()},bezierCurveTo:function(){var a=arguments;this._context.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5])},clearRect:function(){var a=arguments;this._context.clearRect(a[0],a[1],a[2],a[3])},clip:function(){this._context.clip()},closePath:function(){this._context.closePath()},createImageData:function(){var a=arguments;return 2===a.length?this._context.createImageData(a[0],a[1]):1===a.length?this._context.createImageData(a[0]):void 0},createLinearGradient:function(){var a=arguments;return this._context.createLinearGradient(a[0],a[1],a[2],a[3])},createPattern:function(){var a=arguments;return this._context.createPattern(a[0],a[1])},createRadialGradient:function(){var a=arguments;return this._context.createRadialGradient(a[0],a[1],a[2],a[3],a[4],a[5])},drawImage:function(){var a=arguments,_context=this._context;3===a.length?_context.drawImage(a[0],a[1],a[2]):5===a.length?_context.drawImage(a[0],a[1],a[2],a[3],a[4]):9===a.length&&_context.drawImage(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},fill:function(){this._context.fill()},fillText:function(){var a=arguments;this._context.fillText(a[0],a[1],a[2])},getImageData:function(){var a=arguments;return this._context.getImageData(a[0],a[1],a[2],a[3])},lineTo:function(){var a=arguments;this._context.lineTo(a[0],a[1])},moveTo:function(){var a=arguments;this._context.moveTo(a[0],a[1])},rect:function(){var a=arguments;this._context.rect(a[0],a[1],a[2],a[3])},putImageData:function(){var a=arguments;this._context.putImageData(a[0],a[1],a[2])},quadraticCurveTo:function(){var a=arguments;this._context.quadraticCurveTo(a[0],a[1],a[2],a[3])},restore:function(){this._context.restore()},rotate:function(){var a=arguments;this._context.rotate(a[0])},save:function(){this._context.save()},scale:function(){var a=arguments;this._context.scale(a[0],a[1])},setLineDash:function(){var a=arguments,_context=this._context;this._context.setLineDash?_context.setLineDash(a[0]):"mozDash"in _context?_context.mozDash=a[0]:"webkitLineDash"in _context&&(_context.webkitLineDash=a[0])},setTransform:function(){var a=arguments;this._context.setTransform(a[0],a[1],a[2],a[3],a[4],a[5])},stroke:function(){this._context.stroke()},strokeText:function(){var a=arguments;this._context.strokeText(a[0],a[1],a[2])},transform:function(){var a=arguments;this._context.transform(a[0],a[1],a[2],a[3],a[4],a[5])},translate:function(){var a=arguments;this._context.translate(a[0],a[1])},_enableTrace:function(){var that=this,len=CONTEXT_METHODS.length,_simplifyArray=Kinetic.Util._simplifyArray,origSetter=this.setAttr,n,args,func=function(methodName){var origMethod=that[methodName],ret;that[methodName]=function(){return args=_simplifyArray(Array.prototype.slice.call(arguments,0)),ret=origMethod.apply(that,arguments),that._trace({method:methodName,args:args}),ret}};for(n=0;n<len;n++)func(CONTEXT_METHODS[n]);that.setAttr=function(){origSetter.apply(that,arguments),that._trace({property:arguments[0],val:arguments[1]})}}},Kinetic.SceneContext=function(canvas){Kinetic.Context.call(this,canvas)},Kinetic.SceneContext.prototype={_fillColor:function(shape){var fill=shape.fill()||Kinetic.Util._getRGBAString({red:shape.fillRed(),green:shape.fillGreen(),blue:shape.fillBlue(),alpha:shape.fillAlpha()});this.setAttr("fillStyle",fill),shape._fillFunc(this)},_fillPattern:function(shape){var fillPatternImage=shape.getFillPatternImage(),fillPatternX=shape.getFillPatternX(),fillPatternY=shape.getFillPatternY(),fillPatternScale=shape.getFillPatternScale(),fillPatternRotation=Kinetic.getAngle(shape.getFillPatternRotation()),fillPatternOffset=shape.getFillPatternOffset(),fillPatternRepeat=shape.getFillPatternRepeat();(fillPatternX||fillPatternY)&&this.translate(fillPatternX||0,fillPatternY||0),fillPatternRotation&&this.rotate(fillPatternRotation),fillPatternScale&&this.scale(fillPatternScale.x,fillPatternScale.y),fillPatternOffset&&this.translate(-1*fillPatternOffset.x,-1*fillPatternOffset.y),this.setAttr("fillStyle",this.createPattern(fillPatternImage,fillPatternRepeat||"repeat")),this.fill()},_fillLinearGradient:function(shape){var start=shape.getFillLinearGradientStartPoint(),end=shape.getFillLinearGradientEndPoint(),colorStops=shape.getFillLinearGradientColorStops(),grd=this.createLinearGradient(start.x,start.y,end.x,end.y);if(colorStops){for(var n=0;n<colorStops.length;n+=2)grd.addColorStop(colorStops[n],colorStops[n+1]);this.setAttr("fillStyle",grd),this.fill()}},_fillRadialGradient:function(shape){for(var start=shape.getFillRadialGradientStartPoint(),end=shape.getFillRadialGradientEndPoint(),startRadius=shape.getFillRadialGradientStartRadius(),endRadius=shape.getFillRadialGradientEndRadius(),colorStops=shape.getFillRadialGradientColorStops(),grd=this.createRadialGradient(start.x,start.y,startRadius,end.x,end.y,endRadius),n=0;n<colorStops.length;n+=2)grd.addColorStop(colorStops[n],colorStops[n+1]);this.setAttr("fillStyle",grd),this.fill()},_fill:function(shape){var hasColor=shape.fill()||shape.fillRed()||shape.fillGreen()||shape.fillBlue(),hasPattern=shape.getFillPatternImage(),hasLinearGradient=shape.getFillLinearGradientColorStops(),hasRadialGradient=shape.getFillRadialGradientColorStops(),fillPriority=shape.getFillPriority();hasColor&&"color"===fillPriority?this._fillColor(shape):hasPattern&&"pattern"===fillPriority?this._fillPattern(shape):hasLinearGradient&&"linear-gradient"===fillPriority?this._fillLinearGradient(shape):hasRadialGradient&&"radial-gradient"===fillPriority?this._fillRadialGradient(shape):hasColor?this._fillColor(shape):hasPattern?this._fillPattern(shape):hasLinearGradient?this._fillLinearGradient(shape):hasRadialGradient&&this._fillRadialGradient(shape)},_stroke:function(shape){var dash=shape.dash(),strokeScaleEnabled=shape.getStrokeScaleEnabled();shape.hasStroke()&&(strokeScaleEnabled||(this.save(),this.setTransform(1,0,0,1,0,0)),this._applyLineCap(shape),dash&&shape.dashEnabled()&&this.setLineDash(dash),this.setAttr("lineWidth",shape.strokeWidth()),this.setAttr("strokeStyle",shape.stroke()||Kinetic.Util._getRGBAString({red:shape.strokeRed(),green:shape.strokeGreen(),blue:shape.strokeBlue(),alpha:shape.strokeAlpha()})),shape._strokeFunc(this),strokeScaleEnabled||this.restore())},_applyShadow:function(shape){var util=Kinetic.Util,absOpacity=shape.getAbsoluteOpacity(),color=util.get(shape.getShadowColor(),"black"),blur=util.get(shape.getShadowBlur(),5),shadowOpacity=util.get(shape.getShadowOpacity(),1),offset=util.get(shape.getShadowOffset(),{x:0,y:0});shadowOpacity&&this.setAttr("globalAlpha",shadowOpacity*absOpacity),this.setAttr("shadowColor",color),this.setAttr("shadowBlur",blur),this.setAttr("shadowOffsetX",offset.x),this.setAttr("shadowOffsetY",offset.y)}},Kinetic.Util.extend(Kinetic.SceneContext,Kinetic.Context),Kinetic.HitContext=function(canvas){Kinetic.Context.call(this,canvas)},Kinetic.HitContext.prototype={_fill:function(shape){this.save(),this.setAttr("fillStyle",shape.colorKey),shape._fillFuncHit(this),this.restore()},_stroke:function(shape){shape.hasStroke()&&(this._applyLineCap(shape),this.setAttr("lineWidth",shape.strokeWidth()),this.setAttr("strokeStyle",shape.colorKey),shape._strokeFuncHit(this))}},Kinetic.Util.extend(Kinetic.HitContext,Kinetic.Context)}(),function(){var GET="get",RGB="RGB",SET="set";Kinetic.Factory={addGetterSetter:function(constructor,attr,def,validator,after){this.addGetter(constructor,attr,def),this.addSetter(constructor,attr,validator,after),this.addOverloadedGetterSetter(constructor,attr)},addGetter:function(constructor,attr,def){var method=GET+Kinetic.Util._capitalize(attr);constructor.prototype[method]=function(){var val=this.attrs[attr];return void 0===val?def:val}},addSetter:function(constructor,attr,validator,after){var method=SET+Kinetic.Util._capitalize(attr);constructor.prototype[method]=function(val){return validator&&(val=validator.call(this,val)),this._setAttr(attr,val),after&&after.call(this),this}},addComponentsGetterSetter:function(constructor,attr,components,validator,after){var len=components.length,capitalize=Kinetic.Util._capitalize,getter=GET+capitalize(attr),setter=SET+capitalize(attr),n,component;constructor.prototype[getter]=function(){var ret={};for(n=0;n<len;n++)ret[component=components[n]]=this.getAttr(attr+capitalize(component));return ret},constructor.prototype[setter]=function(val){var oldVal=this.attrs[attr],key;for(key in validator&&(val=validator.call(this,val)),val)this._setAttr(attr+capitalize(key),val[key]);return this._fireChangeEvent(attr,oldVal,val),after&&after.call(this),this},this.addOverloadedGetterSetter(constructor,attr)},addOverloadedGetterSetter:function(constructor,attr){var capitalizedAttr=Kinetic.Util._capitalize(attr),setter=SET+capitalizedAttr,getter=GET+capitalizedAttr;constructor.prototype[attr]=function(){return arguments.length?(this[setter](arguments[0]),this):this[getter]()}},backCompat:function(constructor,methods){var key;for(key in methods)constructor.prototype[key]=constructor.prototype[methods[key]]},afterSetFilter:function(){this._filterUpToDate=!1}},Kinetic.Validators={RGBComponent:function(val){return val>255?255:val<0?0:Math.round(val)},alphaComponent:function(val){return val>1?1:val<1e-4?1e-4:val}}}(),function(){var ABSOLUTE_OPACITY="absoluteOpacity",ABSOLUTE_TRANSFORM="absoluteTransform",CHANGE="Change",CHILDREN="children",DOT=".",EMPTY_STRING="",GET="get",ID="id",KINETIC="kinetic",LISTENING="listening",MOUSEENTER="mouseenter",MOUSELEAVE="mouseleave",NAME="name",SET="set",SHAPE="Shape",SPACE=" ",STAGE="stage",TRANSFORM="transform",UPPER_STAGE="Stage",VISIBLE="visible",CLONE_BLACK_LIST=["id"],TRANSFORM_CHANGE_STR=["xChange.kinetic","yChange.kinetic","scaleXChange.kinetic","scaleYChange.kinetic","skewXChange.kinetic","skewYChange.kinetic","rotationChange.kinetic","offsetXChange.kinetic","offsetYChange.kinetic","transformsEnabledChange.kinetic"].join(" ");Kinetic.Util.addMethods(Kinetic.Node,{_init:function(config){var that=this;this._id=Kinetic.idCounter++,this.eventListeners={},this.attrs={},this._cache={},this._filterUpToDate=!1,this.setAttrs(config),this.on(TRANSFORM_CHANGE_STR,(function(){this._clearCache(TRANSFORM),that._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM)})),this.on("visibleChange.kinetic",(function(){that._clearSelfAndDescendantCache(VISIBLE)})),this.on("listeningChange.kinetic",(function(){that._clearSelfAndDescendantCache(LISTENING)})),this.on("opacityChange.kinetic",(function(){that._clearSelfAndDescendantCache(ABSOLUTE_OPACITY)}))},_clearCache:function(attr){attr?delete this._cache[attr]:this._cache={}},_getCache:function(attr,privateGetter){var cache;return void 0===this._cache[attr]&&(this._cache[attr]=privateGetter.call(this)),this._cache[attr]},_clearSelfAndDescendantCache:function(attr){this._clearCache(attr),this.children&&this.getChildren().each((function(node){node._clearSelfAndDescendantCache(attr)}))},clearCache:function(){return delete this._cache.canvas,this._filterUpToDate=!1,this},cache:function(config){var conf=config||{},x=conf.x||0,y=conf.y||0,width=conf.width||this.width(),height=conf.height||this.height(),drawBorder=conf.drawBorder||!1;if(0!==width&&0!==height){var cachedSceneCanvas=new Kinetic.SceneCanvas({pixelRatio:1,width:width,height:height}),cachedFilterCanvas=new Kinetic.SceneCanvas({pixelRatio:1,width:width,height:height}),cachedHitCanvas=new Kinetic.HitCanvas({width:width,height:height}),sceneContext=cachedSceneCanvas.getContext(),hitContext=cachedHitCanvas.getContext();return cachedHitCanvas.isCache=!0,this.clearCache(),sceneContext.save(),hitContext.save(),drawBorder&&(sceneContext.save(),sceneContext.beginPath(),sceneContext.rect(0,0,width,height),sceneContext.closePath(),sceneContext.setAttr("strokeStyle","red"),sceneContext.setAttr("lineWidth",5),sceneContext.stroke(),sceneContext.restore()),sceneContext.translate(-1*x,-1*y),hitContext.translate(-1*x,-1*y),"Shape"===this.nodeType&&(sceneContext.translate(-1*this.x(),-1*this.y()),hitContext.translate(-1*this.x(),-1*this.y())),this.drawScene(cachedSceneCanvas,this),this.drawHit(cachedHitCanvas,this),sceneContext.restore(),hitContext.restore(),this._cache.canvas={scene:cachedSceneCanvas,filter:cachedFilterCanvas,hit:cachedHitCanvas},this}Kinetic.Util.warn("Width or height of caching configuration equals 0. Cache is ignored.")},_drawCachedSceneCanvas:function(context){context.save(),this.getLayer()._applyTransform(this,context),context._applyOpacity(this),context.drawImage(this._getCachedSceneCanvas()._canvas,0,0),context.restore()},_getCachedSceneCanvas:function(){var filters=this.filters(),cachedCanvas=this._cache.canvas,sceneCanvas=cachedCanvas.scene,filterCanvas=cachedCanvas.filter,filterContext=filterCanvas.getContext(),len,imageData,n,filter;if(filters){if(!this._filterUpToDate){try{for(len=filters.length,filterContext.clear(),filterContext.drawImage(sceneCanvas._canvas,0,0),imageData=filterContext.getImageData(0,0,filterCanvas.getWidth(),filterCanvas.getHeight()),n=0;n<len;n++)(filter=filters[n]).call(this,imageData),filterContext.putImageData(imageData,0,0)}catch(e){Kinetic.Util.warn("Unable to apply filter. "+e.message)}this._filterUpToDate=!0}return filterCanvas}return sceneCanvas},_drawCachedHitCanvas:function(context){var cachedCanvas,hitCanvas=this._cache.canvas.hit;context.save(),this.getLayer()._applyTransform(this,context),context.drawImage(hitCanvas._canvas,0,0),context.restore()},on:function(evtStr,handler){var events=evtStr.split(" "),len=events.length,n,event,parts,baseEvent,name;for(n=0;n<len;n++)baseEvent=(parts=(event=events[n]).split("."))[0],name=parts[1]||"",this.eventListeners[baseEvent]||(this.eventListeners[baseEvent]=[]),this.eventListeners[baseEvent].push({name:name,handler:handler});return this},off:function(evtStr){var events=(evtStr||"").split(" "),len=events.length,n,t,event,parts,baseEvent,name;if(!evtStr)for(t in this.eventListeners)this._off(t);for(n=0;n<len;n++)if(baseEvent=(parts=(event=events[n]).split("."))[0],name=parts[1],baseEvent)this.eventListeners[baseEvent]&&this._off(baseEvent,name);else for(t in this.eventListeners)this._off(t,name);return this},dispatchEvent:function(evt){var e={target:this,type:evt.type,evt:evt};this.fire(evt.type,e)},addEventListener:function(type,handler){this.on(type,(function(evt){handler.call(this,evt.evt)}))},removeEventListener:function(type){this.off(type)},remove:function(){var parent=this.getParent();return parent&&parent.children&&(parent.children.splice(this.index,1),parent._setChildrenIndices(),delete this.parent),this._clearSelfAndDescendantCache(STAGE),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM),this._clearSelfAndDescendantCache(VISIBLE),this._clearSelfAndDescendantCache(LISTENING),this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY),this},destroy:function(){Kinetic._removeId(this.getId()),Kinetic._removeName(this.getName(),this._id),this.remove()},getAttr:function(attr){var method=GET+Kinetic.Util._capitalize(attr);return Kinetic.Util._isFunction(this[method])?this[method]():this.attrs[attr]},getAncestors:function(){for(var parent=this.getParent(),ancestors=new Kinetic.Collection;parent;)ancestors.push(parent),parent=parent.getParent();return ancestors},getAttrs:function(){return this.attrs||{}},setAttrs:function(config){var key,method;if(config)for(key in config)key===CHILDREN||config[key]instanceof Kinetic.Node||(method=SET+Kinetic.Util._capitalize(key),Kinetic.Util._isFunction(this[method])?this[method](config[key]):this._setAttr(key,config[key]));return this},isListening:function(){return this._getCache(LISTENING,this._isListening)},_isListening:function(){var listening=this.getListening(),parent=this.getParent();return"inherit"===listening?!parent||parent.isListening():listening},isVisible:function(){return this._getCache(VISIBLE,this._isVisible)},_isVisible:function(){var visible=this.getVisible(),parent=this.getParent();return"inherit"===visible?!parent||parent.isVisible():visible},shouldDrawHit:function(canvas){var layer=this.getLayer();return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isListening()&&this.isVisible()},show:function(){return this.setVisible(!0),this},hide:function(){return this.setVisible(!1),this},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){var depth=this.getDepth(),that=this,index=0,nodes,len,n,child;function addChildren(children){for(nodes=[],len=children.length,n=0;n<len;n++)child=children[n],index++,child.nodeType!==SHAPE&&(nodes=nodes.concat(child.getChildren().toArray())),child._id===that._id&&(n=len);nodes.length>0&&nodes[0].getDepth()<=depth&&addChildren(nodes)}return"Stage"!==that.nodeType&&addChildren(that.getStage().getChildren()),index},getDepth:function(){for(var depth=0,parent=this.parent;parent;)depth++,parent=parent.parent;return depth},setPosition:function(pos){return this.setX(pos.x),this.setY(pos.y),this},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(){var absoluteMatrix=this.getAbsoluteTransform().getMatrix(),absoluteTransform=new Kinetic.Transform,offset=this.offset();return absoluteTransform.m=absoluteMatrix.slice(),absoluteTransform.translate(offset.x,offset.y),absoluteTransform.getTranslation()},setAbsolutePosition:function(pos){var origTrans=this._clearTransform(),it;return this.attrs.x=origTrans.x,this.attrs.y=origTrans.y,delete origTrans.x,delete origTrans.y,(it=this.getAbsoluteTransform()).invert(),it.translate(pos.x,pos.y),pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y},this.setPosition({x:pos.x,y:pos.y}),this._setTransform(origTrans),this},_setTransform:function(trans){var key;for(key in trans)this.attrs[key]=trans[key];this._clearCache(TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM)},_clearTransform:function(){var trans={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,this._clearCache(TRANSFORM),this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM),trans},move:function(change){var changeX=change.x,changeY=change.y,x=this.getX(),y=this.getY();return void 0!==changeX&&(x+=changeX),void 0!==changeY&&(y+=changeY),this.setPosition({x:x,y:y}),this},_eachAncestorReverse:function(func,top){var family=[],parent=this.getParent(),len,n;if(top&&top._id===this._id)return func(this),!0;for(family.unshift(this);parent&&(!top||parent._id!==top._id);)family.unshift(parent),parent=parent.parent;for(len=family.length,n=0;n<len;n++)func(family[n])},rotate:function(theta){return this.setRotation(this.getRotation()+theta),this},moveToTop:function(){if(this.parent){var index=this.index;return this.parent.children.splice(index,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0}Kinetic.Util.warn("Node has no parent. moveToTop function is ignored.")},moveUp:function(){if(this.parent){var index=this.index,len;return index<this.parent.getChildren().length-1&&(this.parent.children.splice(index,1),this.parent.children.splice(index+1,0,this),this.parent._setChildrenIndices(),!0)}Kinetic.Util.warn("Node has no parent. moveUp function is ignored.")},moveDown:function(){if(this.parent){var index=this.index;return index>0&&(this.parent.children.splice(index,1),this.parent.children.splice(index-1,0,this),this.parent._setChildrenIndices(),!0)}Kinetic.Util.warn("Node has no parent. moveDown function is ignored.")},moveToBottom:function(){if(this.parent){var index=this.index;return index>0&&(this.parent.children.splice(index,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0)}Kinetic.Util.warn("Node has no parent. moveToBottom function is ignored.")},setZIndex:function(zIndex){if(this.parent){var index=this.index;return this.parent.children.splice(index,1),this.parent.children.splice(zIndex,0,this),this.parent._setChildrenIndices(),this}Kinetic.Util.warn("Node has no parent. zIndex parameter is ignored.")},getAbsoluteOpacity:function(){return this._getCache(ABSOLUTE_OPACITY,this._getAbsoluteOpacity)},_getAbsoluteOpacity:function(){var absOpacity=this.getOpacity();return this.getParent()&&(absOpacity*=this.getParent().getAbsoluteOpacity()),absOpacity},moveTo:function(newContainer){return this.getParent()!==newContainer&&(this.remove(),newContainer.add(this)),this},toObject:function(){var type=Kinetic.Util,obj={},attrs=this.getAttrs(),key,val,getter,defaultValue;for(key in obj.attrs={},attrs)val=attrs[key],type._isFunction(val)||type._isElement(val)||type._isObject(val)&&type._hasMethods(val)||(getter=this[key],delete attrs[key],defaultValue=getter?getter.call(this):null,attrs[key]=val,defaultValue!==val&&(obj.attrs[key]=val));return obj.className=this.getClassName(),obj},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){var parent=this.getParent();return parent?parent.getLayer():null},getStage:function(){return this._getCache(STAGE,this._getStage)},_getStage:function(){var parent=this.getParent();return parent?parent.getStage():void 0},fire:function(eventType,evt,bubble){return bubble?this._fireAndBubble(eventType,evt||{}):this._fire(eventType,evt||{}),this},getAbsoluteTransform:function(top){return top?this._getAbsoluteTransform(top):this._getCache(ABSOLUTE_TRANSFORM,this._getAbsoluteTransform)},_getAbsoluteTransform:function(top){var at=new Kinetic.Transform,transformsEnabled,trans;return this._eachAncestorReverse((function(node){transformsEnabled=node.transformsEnabled(),trans=node.getTransform(),"all"===transformsEnabled?at.multiply(trans):"position"===transformsEnabled&&at.translate(node.x(),node.y())}),top),at},getTransform:function(){return this._getCache(TRANSFORM,this._getTransform)},_getTransform:function(){var m=new Kinetic.Transform,x=this.getX(),y=this.getY(),rotation=Kinetic.getAngle(this.getRotation()),scaleX=this.getScaleX(),scaleY=this.getScaleY(),skewX=this.getSkewX(),skewY=this.getSkewY(),offsetX=this.getOffsetX(),offsetY=this.getOffsetY();return 0===x&&0===y||m.translate(x,y),0!==rotation&&m.rotate(rotation),0===skewX&&0===skewY||m.skew(skewX,skewY),1===scaleX&&1===scaleY||m.scale(scaleX,scaleY),0===offsetX&&0===offsetY||m.translate(-1*offsetX,-1*offsetY),m},clone:function(obj){var className=this.getClassName(),attrs=Kinetic.Util.cloneObject(this.attrs),key,allListeners,len,n,listener;for(var i in CLONE_BLACK_LIST){var blockAttr;delete attrs[CLONE_BLACK_LIST[i]]}for(key in obj)attrs[key]=obj[key];var node=new Kinetic[className](attrs);for(key in this.eventListeners)for(len=(allListeners=this.eventListeners[key]).length,n=0;n<len;n++)(listener=allListeners[n]).name.indexOf(KINETIC)<0&&(node.eventListeners[key]||(node.eventListeners[key]=[]),node.eventListeners[key].push(listener));return node},toDataURL:function(config){var mimeType=(config=config||{}).mimeType||null,quality=config.quality||null,stage=this.getStage(),x=config.x||0,y=config.y||0,canvas=new Kinetic.SceneCanvas({width:config.width||this.getWidth()||(stage?stage.getWidth():0),height:config.height||this.getHeight()||(stage?stage.getHeight():0),pixelRatio:1}),context=canvas.getContext();return context.save(),(x||y)&&context.translate(-1*x,-1*y),this.drawScene(canvas),context.restore(),canvas.toDataURL(mimeType,quality)},toImage:function(config){Kinetic.Util._getImage(this.toDataURL(config),(function(img){config.callback(img)}))},setSize:function(size){return this.setWidth(size.width),this.setHeight(size.height),this},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},getClassName:function(){return this.className||this.nodeType},getType:function(){return this.nodeType},getDragDistance:function(){return void 0!==this.attrs.dragDistance?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():Kinetic.dragDistance},_get:function(selector){return this.className===selector||this.nodeType===selector?[this]:[]},_off:function(type,name){var evtListeners=this.eventListeners[type],i,evtName;for(i=0;i<evtListeners.length;i++)if(!("kinetic"===(evtName=evtListeners[i].name)&&"kinetic"!==name||name&&evtName!==name)){if(evtListeners.splice(i,1),0===evtListeners.length){delete this.eventListeners[type];break}i--}},_fireChangeEvent:function(attr,oldVal,newVal){this._fire(attr+CHANGE,{oldVal:oldVal,newVal:newVal})},setId:function(id){var oldId=this.getId();return Kinetic._removeId(oldId),Kinetic._addId(this,id),this._setAttr(ID,id),this},setName:function(name){var oldName=this.getName();return Kinetic._removeName(oldName,this._id),Kinetic._addName(this,name),this._setAttr(NAME,name),this},setAttr:function(attr,val){var method,func=this[SET+Kinetic.Util._capitalize(attr)];return Kinetic.Util._isFunction(func)?func.call(this,val):this._setAttr(attr,val),this},_setAttr:function(key,val){var oldVal;void 0!==val&&(oldVal=this.attrs[key],this.attrs[key]=val,this._fireChangeEvent(key,oldVal,val))},_setComponentAttr:function(key,component,val){var oldVal;void 0!==val&&((oldVal=this.attrs[key])||(this.attrs[key]=this.getAttr(key)),this.attrs[key][component]=val,this._fireChangeEvent(key,oldVal,val))},_fireAndBubble:function(eventType,evt,compareShape){var okayToRun=!0;if(evt&&this.nodeType===SHAPE&&(evt.target=this),eventType===MOUSEENTER&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))?okayToRun=!1:eventType===MOUSELEAVE&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))&&(okayToRun=!1),okayToRun){this._fire(eventType,evt);var stopBubble=(eventType===MOUSEENTER||eventType===MOUSELEAVE)&&(compareShape&&compareShape.isAncestorOf&&compareShape.isAncestorOf(this)||!(!compareShape||!compareShape.isAncestorOf));evt&&!evt.cancelBubble&&this.parent&&this.parent.isListening()&&!stopBubble&&(compareShape&&compareShape.parent?this._fireAndBubble.call(this.parent,eventType,evt,compareShape.parent):this._fireAndBubble.call(this.parent,eventType,evt))}},_fire:function(eventType,evt){var events=this.eventListeners[eventType],i;if(evt.type=eventType,events)for(i=0;i<events.length;i++)events[i].handler.call(this,evt)},draw:function(){return this.drawScene(),this.drawHit(),this}}),Kinetic.Node.create=function(json,container){return this._createNode(JSON.parse(json),container)},Kinetic.Node._createNode=function(obj,container){var className=Kinetic.Node.prototype.getClassName.call(obj),children=obj.children,no,len,n;if(container&&(obj.attrs.container=container),no=new Kinetic[className](obj.attrs),children)for(len=children.length,n=0;n<len;n++)no.add(this._createNode(children[n]));return no},Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"position"),Kinetic.Factory.addGetterSetter(Kinetic.Node,"x",0),Kinetic.Factory.addGetterSetter(Kinetic.Node,"y",0),Kinetic.Factory.addGetterSetter(Kinetic.Node,"opacity",1),Kinetic.Factory.addGetter(Kinetic.Node,"name"),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"name"),Kinetic.Factory.addGetter(Kinetic.Node,"id"),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"id"),Kinetic.Factory.addGetterSetter(Kinetic.Node,"rotation",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Node,"scale",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Node,"scaleX",1),Kinetic.Factory.addGetterSetter(Kinetic.Node,"scaleY",1),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Node,"skew",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Node,"skewX",0),Kinetic.Factory.addGetterSetter(Kinetic.Node,"skewY",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Node,"offset",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Node,"offsetX",0),Kinetic.Factory.addGetterSetter(Kinetic.Node,"offsetY",0),Kinetic.Factory.addSetter(Kinetic.Node,"dragDistance"),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"dragDistance"),Kinetic.Factory.addSetter(Kinetic.Node,"width",0),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"width"),Kinetic.Factory.addSetter(Kinetic.Node,"height",0),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"height"),Kinetic.Factory.addGetterSetter(Kinetic.Node,"listening","inherit"),Kinetic.Factory.addGetterSetter(Kinetic.Node,"filters",void 0,(function(val){return this._filterUpToDate=!1,val})),Kinetic.Factory.addGetterSetter(Kinetic.Node,"visible","inherit"),Kinetic.Factory.addGetterSetter(Kinetic.Node,"transformsEnabled","all"),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"size"),Kinetic.Factory.backCompat(Kinetic.Node,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"}),Kinetic.Collection.mapMethods(Kinetic.Node)}(),Kinetic.Filters.Grayscale=function(imageData){var data=imageData.data,len=data.length,i,brightness;for(i=0;i<len;i+=4)brightness=.34*data[i]+.5*data[i+1]+.16*data[i+2],data[i]=brightness,data[i+1]=brightness,data[i+2]=brightness},Kinetic.Filters.Brighten=function(imageData){var brightness=255*this.brightness(),data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4)data[i]+=brightness,data[i+1]+=brightness,data[i+2]+=brightness},Kinetic.Factory.addGetterSetter(Kinetic.Node,"brightness",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Filters.Invert=function(imageData){var data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4)data[i]=255-data[i],data[i+1]=255-data[i+1],data[i+2]=255-data[i+2]},function(){function BlurStack(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function filterGaussBlurRGBA(imageData,radius){var pixels=imageData.data,width=imageData.width,height=imageData.height,x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,a_sum,r_out_sum,g_out_sum,b_out_sum,a_out_sum,r_in_sum,g_in_sum,b_in_sum,a_in_sum,pr,pg,pb,pa,rbs,div=radius+radius+1,widthMinus1=width-1,heightMinus1=height-1,radiusPlus1=radius+1,sumFactor=radiusPlus1*(radiusPlus1+1)/2,stackStart=new BlurStack,stackEnd=null,stack=stackStart,stackIn=null,stackOut=null,mul_sum=mul_table[radius],shg_sum=shg_table[radius];for(i=1;i<div;i++)stack=stack.next=new BlurStack,i==radiusPlus1&&(stackEnd=stack);for(stack.next=stackStart,yw=yi=0,y=0;y<height;y++){for(r_in_sum=g_in_sum=b_in_sum=a_in_sum=r_sum=g_sum=b_sum=a_sum=0,r_out_sum=radiusPlus1*(pr=pixels[yi]),g_out_sum=radiusPlus1*(pg=pixels[yi+1]),b_out_sum=radiusPlus1*(pb=pixels[yi+2]),a_out_sum=radiusPlus1*(pa=pixels[yi+3]),r_sum+=sumFactor*pr,g_sum+=sumFactor*pg,b_sum+=sumFactor*pb,a_sum+=sumFactor*pa,stack=stackStart,i=0;i<radiusPlus1;i++)stack.r=pr,stack.g=pg,stack.b=pb,stack.a=pa,stack=stack.next;for(i=1;i<radiusPlus1;i++)p=yi+((widthMinus1<i?widthMinus1:i)<<2),r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i),g_sum+=(stack.g=pg=pixels[p+1])*rbs,b_sum+=(stack.b=pb=pixels[p+2])*rbs,a_sum+=(stack.a=pa=pixels[p+3])*rbs,r_in_sum+=pr,g_in_sum+=pg,b_in_sum+=pb,a_in_sum+=pa,stack=stack.next;for(stackIn=stackStart,stackOut=stackEnd,x=0;x<width;x++)pixels[yi+3]=pa=a_sum*mul_sum>>shg_sum,0!==pa?(pa=255/pa,pixels[yi]=(r_sum*mul_sum>>shg_sum)*pa,pixels[yi+1]=(g_sum*mul_sum>>shg_sum)*pa,pixels[yi+2]=(b_sum*mul_sum>>shg_sum)*pa):pixels[yi]=pixels[yi+1]=pixels[yi+2]=0,r_sum-=r_out_sum,g_sum-=g_out_sum,b_sum-=b_out_sum,a_sum-=a_out_sum,r_out_sum-=stackIn.r,g_out_sum-=stackIn.g,b_out_sum-=stackIn.b,a_out_sum-=stackIn.a,p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2,r_sum+=r_in_sum+=stackIn.r=pixels[p],g_sum+=g_in_sum+=stackIn.g=pixels[p+1],b_sum+=b_in_sum+=stackIn.b=pixels[p+2],a_sum+=a_in_sum+=stackIn.a=pixels[p+3],stackIn=stackIn.next,r_out_sum+=pr=stackOut.r,g_out_sum+=pg=stackOut.g,b_out_sum+=pb=stackOut.b,a_out_sum+=pa=stackOut.a,r_in_sum-=pr,g_in_sum-=pg,b_in_sum-=pb,a_in_sum-=pa,stackOut=stackOut.next,yi+=4;yw+=width}for(x=0;x<width;x++){for(g_in_sum=b_in_sum=a_in_sum=r_in_sum=g_sum=b_sum=a_sum=r_sum=0,r_out_sum=radiusPlus1*(pr=pixels[yi=x<<2]),g_out_sum=radiusPlus1*(pg=pixels[yi+1]),b_out_sum=radiusPlus1*(pb=pixels[yi+2]),a_out_sum=radiusPlus1*(pa=pixels[yi+3]),r_sum+=sumFactor*pr,g_sum+=sumFactor*pg,b_sum+=sumFactor*pb,a_sum+=sumFactor*pa,stack=stackStart,i=0;i<radiusPlus1;i++)stack.r=pr,stack.g=pg,stack.b=pb,stack.a=pa,stack=stack.next;for(yp=width,i=1;i<=radius;i++)yi=yp+x<<2,r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i),g_sum+=(stack.g=pg=pixels[yi+1])*rbs,b_sum+=(stack.b=pb=pixels[yi+2])*rbs,a_sum+=(stack.a=pa=pixels[yi+3])*rbs,r_in_sum+=pr,g_in_sum+=pg,b_in_sum+=pb,a_in_sum+=pa,stack=stack.next,i<heightMinus1&&(yp+=width);for(yi=x,stackIn=stackStart,stackOut=stackEnd,y=0;y<height;y++)pixels[(p=yi<<2)+3]=pa=a_sum*mul_sum>>shg_sum,pa>0?(pa=255/pa,pixels[p]=(r_sum*mul_sum>>shg_sum)*pa,pixels[p+1]=(g_sum*mul_sum>>shg_sum)*pa,pixels[p+2]=(b_sum*mul_sum>>shg_sum)*pa):pixels[p]=pixels[p+1]=pixels[p+2]=0,r_sum-=r_out_sum,g_sum-=g_out_sum,b_sum-=b_out_sum,a_sum-=a_out_sum,r_out_sum-=stackIn.r,g_out_sum-=stackIn.g,b_out_sum-=stackIn.b,a_out_sum-=stackIn.a,p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2,r_sum+=r_in_sum+=stackIn.r=pixels[p],g_sum+=g_in_sum+=stackIn.g=pixels[p+1],b_sum+=b_in_sum+=stackIn.b=pixels[p+2],a_sum+=a_in_sum+=stackIn.a=pixels[p+3],stackIn=stackIn.next,r_out_sum+=pr=stackOut.r,g_out_sum+=pg=stackOut.g,b_out_sum+=pb=stackOut.b,a_out_sum+=pa=stackOut.a,r_in_sum-=pr,g_in_sum-=pg,b_in_sum-=pb,a_in_sum-=pa,stackOut=stackOut.next,yi+=width}}Kinetic.Filters.Blur=function Blur(imageData){var radius=Math.round(this.blurRadius());radius>0&&filterGaussBlurRGBA(imageData,radius)},Kinetic.Factory.addGetterSetter(Kinetic.Node,"blurRadius",0,null,Kinetic.Factory.afterSetFilter)}(),function(){function pixelAt(idata,x,y){var idx=4*(y*idata.width+x),d=[];return d.push(idata.data[idx++],idata.data[idx++],idata.data[idx++],idata.data[idx++]),d}function rgbDistance(p1,p2){return Math.sqrt(Math.pow(p1[0]-p2[0],2)+Math.pow(p1[1]-p2[1],2)+Math.pow(p1[2]-p2[2],2))}function rgbMean(pTab){for(var m=[0,0,0],i=0;i<pTab.length;i++)m[0]+=pTab[i][0],m[1]+=pTab[i][1],m[2]+=pTab[i][2];return m[0]/=pTab.length,m[1]/=pTab.length,m[2]/=pTab.length,m}function backgroundMask(idata,threshold){var rgbv_no=pixelAt(idata,0,0),rgbv_ne=pixelAt(idata,idata.width-1,0),rgbv_so=pixelAt(idata,0,idata.height-1),rgbv_se=pixelAt(idata,idata.width-1,idata.height-1),thres=threshold||10;if(rgbDistance(rgbv_no,rgbv_ne)<thres&&rgbDistance(rgbv_ne,rgbv_se)<thres&&rgbDistance(rgbv_se,rgbv_so)<thres&&rgbDistance(rgbv_so,rgbv_no)<thres){for(var mean=rgbMean([rgbv_ne,rgbv_no,rgbv_se,rgbv_so]),mask=[],i=0;i<idata.width*idata.height;i++){var d=rgbDistance(mean,[idata.data[4*i],idata.data[4*i+1],idata.data[4*i+2]]);mask[i]=d<thres?0:255}return mask}}function applyMask(idata,mask){for(var i=0;i<idata.width*idata.height;i++)idata.data[4*i+3]=mask[i]}function erodeMask(mask,sw,sh){for(var weights=[1,1,1,1,0,1,1,1,1],side=Math.round(Math.sqrt(weights.length)),halfSide=Math.floor(side/2),maskResult=[],y=0;y<sh;y++)for(var x=0;x<sw;x++){for(var so=y*sw+x,a=0,cy=0;cy<side;cy++)for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide,scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff,wt=weights[cy*side+cx];a+=mask[scy*sw+scx]*wt}}maskResult[so]=2040===a?255:0}return maskResult}function dilateMask(mask,sw,sh){for(var weights=[1,1,1,1,1,1,1,1,1],side=Math.round(Math.sqrt(weights.length)),halfSide=Math.floor(side/2),maskResult=[],y=0;y<sh;y++)for(var x=0;x<sw;x++){for(var so=y*sw+x,a=0,cy=0;cy<side;cy++)for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide,scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff,wt=weights[cy*side+cx];a+=mask[scy*sw+scx]*wt}}maskResult[so]=a>=1020?255:0}return maskResult}function smoothEdgeMask(mask,sw,sh){for(var weights=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9],side=Math.round(Math.sqrt(weights.length)),halfSide=Math.floor(side/2),maskResult=[],y=0;y<sh;y++)for(var x=0;x<sw;x++){for(var so=y*sw+x,a=0,cy=0;cy<side;cy++)for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide,scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff,wt=weights[cy*side+cx];a+=mask[scy*sw+scx]*wt}}maskResult[so]=a}return maskResult}Kinetic.Filters.Mask=function(imageData){var threshold,mask=backgroundMask(imageData,this.threshold());return mask&&applyMask(imageData,mask=smoothEdgeMask(mask=dilateMask(mask=erodeMask(mask,imageData.width,imageData.height),imageData.width,imageData.height),imageData.width,imageData.height)),imageData},Kinetic.Factory.addGetterSetter(Kinetic.Node,"threshold",0,null,Kinetic.Factory.afterSetFilter)}(),Kinetic.Filters.RGB=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),i,brightness;for(i=0;i<nPixels;i+=4)brightness=(.34*data[i]+.5*data[i+1]+.16*data[i+2])/255,data[i]=brightness*red,data[i+1]=brightness*green,data[i+2]=brightness*blue,data[i+3]=data[i+3]},Kinetic.Factory.addGetterSetter(Kinetic.Node,"red",0,(function(val){return this._filterUpToDate=!1,val>255?255:val<0?0:Math.round(val)})),Kinetic.Factory.addGetterSetter(Kinetic.Node,"green",0,(function(val){return this._filterUpToDate=!1,val>255?255:val<0?0:Math.round(val)})),Kinetic.Factory.addGetterSetter(Kinetic.Node,"blue",0,Kinetic.Validators.RGBComponent,Kinetic.Factory.afterSetFilter),Kinetic.Filters.HSV=function(imageData){var data=imageData.data,nPixels=data.length,v=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,i,vsu=v*s*Math.cos(h*Math.PI/180),vsw=v*s*Math.sin(h*Math.PI/180),rr=.299*v+.701*vsu+.167*vsw,rg=.587*v-.587*vsu+.33*vsw,rb=.114*v-.114*vsu-.497*vsw,gr=.299*v-.299*vsu-.328*vsw,gg=.587*v+.413*vsu+.035*vsw,gb=.114*v-.114*vsu+.293*vsw,br=.299*v-.3*vsu+1.25*vsw,bg=.587*v-.586*vsu-1.05*vsw,bb=.114*v+.886*vsu-.2*vsw,r,g,b,a;for(i=0;i<nPixels;i+=4)r=data[i+0],g=data[i+1],b=data[i+2],a=data[i+3],data[i+0]=rr*r+rg*g+rb*b,data[i+1]=gr*r+gg*g+gb*b,data[i+2]=br*r+bg*g+bb*b,data[i+3]=a},Kinetic.Factory.addGetterSetter(Kinetic.Node,"hue",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"saturation",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"value",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"hue",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"saturation",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"luminance",0,null,Kinetic.Factory.afterSetFilter),Kinetic.Filters.HSL=function(imageData){var data=imageData.data,nPixels=data.length,v=1,s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,l=127*this.luminance(),i,vsu=1*s*Math.cos(h*Math.PI/180),vsw=1*s*Math.sin(h*Math.PI/180),rr=.299+.701*vsu+.167*vsw,rg=.587-.587*vsu+.33*vsw,rb=.114-.114*vsu-.497*vsw,gr=.299-.299*vsu-.328*vsw,gg=.587+.413*vsu+.035*vsw,gb=.114-.114*vsu+.293*vsw,br=.299-.3*vsu+1.25*vsw,bg=.587-.586*vsu-1.05*vsw,bb=.114+.886*vsu-.2*vsw,r,g,b,a;for(i=0;i<nPixels;i+=4)r=data[i+0],g=data[i+1],b=data[i+2],a=data[i+3],data[i+0]=rr*r+rg*g+rb*b+l,data[i+1]=gr*r+gg*g+gb*b+l,data[i+2]=br*r+bg*g+bb*b+l,data[i+3]=a},Kinetic.Filters.Emboss=function(imageData){var strength=10*this.embossStrength(),greyLevel=255*this.embossWhiteLevel(),direction=this.embossDirection(),blend=this.embossBlend(),dirY=0,dirX=0,data=imageData.data,w=imageData.width,h=imageData.height,w4=4*w,y=h;switch(direction){case"top-left":dirY=-1,dirX=-1;break;case"top":dirY=-1,dirX=0;break;case"top-right":dirY=-1,dirX=1;break;case"right":dirY=0,dirX=1;break;case"bottom-right":dirY=1,dirX=1;break;case"bottom":dirY=1,dirX=0;break;case"bottom-left":dirY=1,dirX=-1;break;case"left":dirY=0,dirX=-1}do{var offsetY=(y-1)*w4,otherY=dirY;y+otherY<1&&(otherY=0),y+otherY>h&&(otherY=0);var offsetYOther=(y-1+otherY)*w*4,x=w;do{var offset=offsetY+4*(x-1),otherX=dirX;x+otherX<1&&(otherX=0),x+otherX>w&&(otherX=0);var offsetOther=offsetYOther+4*(x-1+otherX),dR=data[offset]-data[offsetOther],dG=data[offset+1]-data[offsetOther+1],dB=data[offset+2]-data[offsetOther+2],dif=dR,absDif=dif>0?dif:-dif,absG,absB;if((dG>0?dG:-dG)>absDif&&(dif=dG),(dB>0?dB:-dB)>absDif&&(dif=dB),dif*=strength,blend){var r=data[offset]+dif,g=data[offset+1]+dif,b=data[offset+2]+dif;data[offset]=r>255?255:r<0?0:r,data[offset+1]=g>255?255:g<0?0:g,data[offset+2]=b>255?255:b<0?0:b}else{var grey=greyLevel-dif;grey<0?grey=0:grey>255&&(grey=255),data[offset]=data[offset+1]=data[offset+2]=grey}}while(--x)}while(--y)},Kinetic.Factory.addGetterSetter(Kinetic.Node,"embossStrength",.5,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"embossWhiteLevel",.5,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"embossDirection","top-left",null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"embossBlend",!1,null,Kinetic.Factory.afterSetFilter),function(){function remap(fromValue,fromMin,fromMax,toMin,toMax){var fromRange=fromMax-fromMin,toRange=toMax-toMin,toValue;return 0===fromRange?toMin+toRange/2:0===toRange?toMin:toValue=toRange*(toValue=(fromValue-fromMin)/fromRange)+toMin}Kinetic.Filters.Enhance=function(imageData){var data=imageData.data,nSubPixels=data.length,rMin=data[0],rMax=rMin,r,gMin=data[1],gMax=gMin,g,bMin=data[2],bMax=bMin,b,i,enhanceAmount=this.enhance();if(0!==enhanceAmount){for(i=0;i<nSubPixels;i+=4)(r=data[i+0])<rMin?rMin=r:r>rMax&&(rMax=r),(g=data[i+1])<gMin?gMin=g:g>gMax&&(gMax=g),(b=data[i+2])<bMin?bMin=b:b>bMax&&(bMax=b);var rMid,rGoalMax,rGoalMin,gMid,gGoalMax,gGoalMin,bMid,bGoalMax,bGoalMin;for(rMax===rMin&&(rMax=255,rMin=0),gMax===gMin&&(gMax=255,gMin=0),bMax===bMin&&(bMax=255,bMin=0),enhanceAmount>0?(rGoalMax=rMax+enhanceAmount*(255-rMax),rGoalMin=rMin-enhanceAmount*(rMin-0),gGoalMax=gMax+enhanceAmount*(255-gMax),gGoalMin=gMin-enhanceAmount*(gMin-0),bGoalMax=bMax+enhanceAmount*(255-bMax),bGoalMin=bMin-enhanceAmount*(bMin-0)):(rGoalMax=rMax+enhanceAmount*(rMax-(rMid=.5*(rMax+rMin))),rGoalMin=rMin+enhanceAmount*(rMin-rMid),gGoalMax=gMax+enhanceAmount*(gMax-(gMid=.5*(gMax+gMin))),gGoalMin=gMin+enhanceAmount*(gMin-gMid),bGoalMax=bMax+enhanceAmount*(bMax-(bMid=.5*(bMax+bMin))),bGoalMin=bMin+enhanceAmount*(bMin-bMid)),i=0;i<nSubPixels;i+=4)data[i+0]=remap(data[i+0],rMin,rMax,rGoalMin,rGoalMax),data[i+1]=remap(data[i+1],gMin,gMax,gGoalMin,gGoalMax),data[i+2]=remap(data[i+2],bMin,bMax,bGoalMin,bGoalMax)}},Kinetic.Factory.addGetterSetter(Kinetic.Node,"enhance",0,null,Kinetic.Factory.afterSetFilter)}(),Kinetic.Filters.Posterize=function(imageData){var levels=Math.round(254*this.levels())+1,data=imageData.data,len=data.length,scale=255/levels,i;for(i=0;i<len;i+=1)data[i]=Math.floor(data[i]/scale)*scale},Kinetic.Factory.addGetterSetter(Kinetic.Node,"levels",.5,null,Kinetic.Factory.afterSetFilter),Kinetic.Filters.Noise=function(imageData){var amount=255*this.noise(),data=imageData.data,nPixels=data.length,half=amount/2,i;for(i=0;i<nPixels;i+=4)data[i+0]+=half-2*half*Math.random(),data[i+1]+=half-2*half*Math.random(),data[i+2]+=half-2*half*Math.random()},Kinetic.Factory.addGetterSetter(Kinetic.Node,"noise",.2,null,Kinetic.Factory.afterSetFilter),Kinetic.Filters.Pixelate=function(imageData){var pixelSize=Math.ceil(this.pixelSize()),width=imageData.width,height=imageData.height,x,y,i,red,green,blue,alpha,nBinsX=Math.ceil(width/pixelSize),nBinsY=Math.ceil(height/pixelSize),xBinStart,xBinEnd,yBinStart,yBinEnd,xBin,yBin,pixelsInBin;for(imageData=imageData.data,xBin=0;xBin<nBinsX;xBin+=1)for(yBin=0;yBin<nBinsY;yBin+=1){for(red=0,green=0,blue=0,alpha=0,xBinEnd=(xBinStart=xBin*pixelSize)+pixelSize,yBinEnd=(yBinStart=yBin*pixelSize)+pixelSize,pixelsInBin=0,x=xBinStart;x<xBinEnd;x+=1)if(!(x>=width))for(y=yBinStart;y<yBinEnd;y+=1)y>=height||(red+=imageData[0+(i=4*(width*y+x))],green+=imageData[i+1],blue+=imageData[i+2],alpha+=imageData[i+3],pixelsInBin+=1);for(red/=pixelsInBin,green/=pixelsInBin,blue/=pixelsInBin,x=xBinStart;x<xBinEnd;x+=1)if(!(x>=width))for(y=yBinStart;y<yBinEnd;y+=1)y>=height||(imageData[0+(i=4*(width*y+x))]=red,imageData[i+1]=green,imageData[i+2]=blue,imageData[i+3]=alpha)}},Kinetic.Factory.addGetterSetter(Kinetic.Node,"pixelSize",8,null,Kinetic.Factory.afterSetFilter),Kinetic.Filters.Threshold=function(imageData){var level=255*this.threshold(),data=imageData.data,len=data.length,i;for(i=0;i<len;i+=1)data[i]=data[i]<level?0:255},Kinetic.Factory.addGetterSetter(Kinetic.Node,"threshold",.5,null,Kinetic.Factory.afterSetFilter),
/**
     * Sepia Filter
     * Based on: Pixastic Lib - Sepia filter - v0.1.0
     * Copyright (c) 2008 Jacob Seidelin, jseidelin@nihilogic.dk, http://blog.nihilogic.dk/
     * @function
     * @name Sepia
     * @memberof Kinetic.Filters
     * @param {Object} imageData
     * @author Jacob Seidelin <jseidelin@nihilogic.dk>
     * @license MPL v1.1 [http://www.pixastic.com/lib/license.txt]
     * @example
     * node.cache();
     * node.filters([Kinetic.Filters.Sepia]);
     */
Kinetic.Filters.Sepia=function(imageData){var data=imageData.data,w=imageData.width,y=imageData.height,w4=4*w,offsetY,x,offset,or,og,ob,r,g,b;do{offsetY=(y-1)*w4,x=w;do{r=.393*(or=data[offset=offsetY+4*(x-1)])+.769*(og=data[offset+1])+.189*(ob=data[offset+2]),g=.349*or+.686*og+.168*ob,b=.272*or+.534*og+.131*ob,data[offset]=r>255?255:r,data[offset+1]=g>255?255:g,data[offset+2]=b>255?255:b,data[offset+3]=data[offset+3]}while(--x)}while(--y)},Kinetic.Filters.Solarize=function(imageData){var data=imageData.data,w=imageData.width,h,w4=4*w,y=imageData.height;do{var offsetY=(y-1)*w4,x=w;do{var offset=offsetY+4*(x-1),r=data[offset],g=data[offset+1],b=data[offset+2];r>127&&(r=255-r),g>127&&(g=255-g),b>127&&(b=255-b),data[offset]=r,data[offset+1]=g,data[offset+2]=b}while(--x)}while(--y)},function(){var ToPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,r=0,g=0,b=0,a=0,rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid,y=ySize-yMid,rMax=(rad=Math.sqrt(x*x+y*y))>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta,conversion=360/tSize*Math.PI/180,sin,cos;for(theta=0;theta<tSize;theta+=1)for(sin=Math.sin(theta*conversion),cos=Math.cos(theta*conversion),radius=0;radius<rSize;radius+=1)x=Math.floor(xMid+rMax*radius/rSize*cos),r=srcPixels[(i=4*((y=Math.floor(yMid+rMax*radius/rSize*sin))*xSize+x))+0],g=srcPixels[i+1],b=srcPixels[i+2],a=srcPixels[i+3],dstPixels[(i=4*(theta+radius*xSize))+0]=r,dstPixels[i+1]=g,dstPixels[i+2]=b,dstPixels[i+3]=a},FromPolar=function(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,dx,dy,r=0,g=0,b=0,a=0,rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid,y=ySize-yMid,rMax=(rad=Math.sqrt(x*x+y*y))>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta,phaseShift=opt.polarRotation||0,x1,y1;for(x=0;x<xSize;x+=1)for(y=0;y<ySize;y+=1)dx=x-xMid,dy=y-yMid,radius=Math.sqrt(dx*dx+dy*dy)*rSize/rMax,theta=(theta=(180*Math.atan2(dy,dx)/Math.PI+360+phaseShift)%360)*tSize/360,x1=Math.floor(theta),r=srcPixels[(i=4*((y1=Math.floor(radius))*xSize+x1))+0],g=srcPixels[i+1],b=srcPixels[i+2],a=srcPixels[i+3],dstPixels[(i=4*(y*xSize+x))+0]=r,dstPixels[i+1]=g,dstPixels[i+2]=b,dstPixels[i+3]=a},tempCanvas=Kinetic.Util.createCanvasElement();Kinetic.Filters.Kaleidoscope=function(imageData){var xSize=imageData.width,ySize=imageData.height,x,y,xoff,i,r,g,b,a,srcPos,dstPos,power=Math.round(this.kaleidoscopePower()),angle=Math.round(this.kaleidoscopeAngle()),offset=Math.floor(xSize*(angle%360)/360);if(!(power<1)){tempCanvas.width=xSize,tempCanvas.height=ySize;var scratchData=tempCanvas.getContext("2d").getImageData(0,0,xSize,ySize);ToPolar(imageData,scratchData,{polarCenterX:xSize/2,polarCenterY:ySize/2});for(var minSectionSize=xSize/Math.pow(2,power);minSectionSize<=8;)minSectionSize*=2,power-=1;var sectionSize=minSectionSize=Math.ceil(minSectionSize),xStart=0,xEnd=sectionSize,xDelta=1;for(offset+minSectionSize>xSize&&(xStart=sectionSize,xEnd=0,xDelta=-1),y=0;y<ySize;y+=1)for(x=xStart;x!==xEnd;x+=xDelta)srcPos=4*(xSize*y+(xoff=Math.round(x+offset)%xSize)),r=scratchData.data[srcPos+0],g=scratchData.data[srcPos+1],b=scratchData.data[srcPos+2],a=scratchData.data[srcPos+3],dstPos=4*(xSize*y+x),scratchData.data[dstPos+0]=r,scratchData.data[dstPos+1]=g,scratchData.data[dstPos+2]=b,scratchData.data[dstPos+3]=a;for(y=0;y<ySize;y+=1)for(sectionSize=Math.floor(minSectionSize),i=0;i<power;i+=1){for(x=0;x<sectionSize+1;x+=1)srcPos=4*(xSize*y+x),r=scratchData.data[srcPos+0],g=scratchData.data[srcPos+1],b=scratchData.data[srcPos+2],a=scratchData.data[srcPos+3],dstPos=4*(xSize*y+2*sectionSize-x-1),scratchData.data[dstPos+0]=r,scratchData.data[dstPos+1]=g,scratchData.data[dstPos+2]=b,scratchData.data[dstPos+3]=a;sectionSize*=2}FromPolar(scratchData,imageData,{polarRotation:0})}},Kinetic.Factory.addGetterSetter(Kinetic.Node,"kaleidoscopePower",2,null,Kinetic.Factory.afterSetFilter),Kinetic.Factory.addGetterSetter(Kinetic.Node,"kaleidoscopeAngle",0,null,Kinetic.Factory.afterSetFilter)}(),function(){var BATCH_DRAW_STOP_TIME_DIFF=500,now=Kinetic.root.performance&&Kinetic.root.performance.now?function(){return Kinetic.root.performance.now()}:function(){return(new Date).getTime()},RAF=Kinetic.root.requestAnimationFrame||Kinetic.root.webkitRequestAnimationFrame||Kinetic.root.mozRequestAnimationFrame||Kinetic.root.oRequestAnimationFrame||Kinetic.root.msRequestAnimationFrame||FRAF;function FRAF(callback){setTimeout(callback,1e3/60)}function requestAnimFrame(){return RAF.apply(Kinetic.root,arguments)}Kinetic.Animation=function(func,layers){var Anim=Kinetic.Animation;this.func=func,this.setLayers(layers),this.id=Anim.animIdCounter++,this.frame={time:0,timeDiff:0,lastTime:now()}},Kinetic.Animation.prototype={setLayers:function(layers){var lays=[];lays=layers?layers.length>0?layers:[layers]:[],this.layers=lays},getLayers:function(){return this.layers},addLayer:function(layer){var layers=this.layers,len,n;if(layers){for(len=layers.length,n=0;n<len;n++)if(layers[n]._id===layer._id)return!1}else this.layers=[];return this.layers.push(layer),!0},isRunning:function(){var a,animations=Kinetic.Animation.animations,len=animations.length,n;for(n=0;n<len;n++)if(animations[n].id===this.id)return!0;return!1},start:function(){var Anim=Kinetic.Animation;this.stop(),this.frame.timeDiff=0,this.frame.lastTime=now(),Anim._addAnimation(this)},stop:function(){Kinetic.Animation._removeAnimation(this)},_updateFrameObject:function(time){this.frame.timeDiff=time-this.frame.lastTime,this.frame.lastTime=time,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1e3/this.frame.timeDiff}},Kinetic.Animation.animations=[],Kinetic.Animation.animIdCounter=0,Kinetic.Animation.animRunning=!1,Kinetic.Animation._addAnimation=function(anim){this.animations.push(anim),this._handleAnimation()},Kinetic.Animation._removeAnimation=function(anim){var id=anim.id,animations=this.animations,len=animations.length,n;for(n=0;n<len;n++)if(animations[n].id===id){this.animations.splice(n,1);break}},Kinetic.Animation._runFrames=function(){var layerHash={},animations=this.animations,anim,layers,func,n,i,layersLen,layer,key,needRedraw;for(n=0;n<animations.length;n++)if(layers=(anim=animations[n]).layers,func=anim.func,anim._updateFrameObject(now()),layersLen=layers.length,needRedraw=!func||!1!==func.call(anim,anim.frame))for(i=0;i<layersLen;i++)void 0!==(layer=layers[i])._id&&(layerHash[layer._id]=layer);for(key in layerHash)layerHash[key].draw()},Kinetic.Animation._animationLoop=function(){var Anim=Kinetic.Animation;Anim.animations.length?(requestAnimFrame(Anim._animationLoop),Anim._runFrames()):Anim.animRunning=!1},Kinetic.Animation._handleAnimation=function(){var that=this;this.animRunning||(this.animRunning=!0,this._animationLoop())};var moveTo=Kinetic.Node.prototype.moveTo;Kinetic.Node.prototype.moveTo=function(container){moveTo.call(this,container)},Kinetic.BaseLayer.prototype.batchDraw=function(){var that=this,Anim=Kinetic.Animation;this.batchAnim||(this.batchAnim=new Anim((function(){that.lastBatchDrawTime&&now()-that.lastBatchDrawTime>500&&that.batchAnim.stop()}),this)),this.lastBatchDrawTime=now(),this.batchAnim.isRunning()||(this.draw(),this.batchAnim.start())},Kinetic.Stage.prototype.batchDraw=function(){this.getChildren().each((function(layer){layer.batchDraw()}))}}(this),function(){var blacklist={node:1,duration:1,easing:1,onFinish:1,yoyo:1},PAUSED=1,PLAYING=2,REVERSING=3,idCounter=0;Kinetic.Tween=function(config){var that=this,node=config.node,nodeId=node._id,duration,easing=config.easing||Kinetic.Easings.Linear,yoyo=!!config.yoyo,key;for(key in duration=void 0===config.duration?1:0===config.duration?.001:config.duration,this.node=node,this._id=idCounter++,this.anim=new Kinetic.Animation((function(){that.tween.onEnterFrame()}),node.getLayer()||(node instanceof Kinetic.Stage?node.getLayers():null)),this.tween=new Tween(key,(function(i){that._tweenFunc(i)}),easing,0,1,1e3*duration,yoyo),this._addListeners(),Kinetic.Tween.attrs[nodeId]||(Kinetic.Tween.attrs[nodeId]={}),Kinetic.Tween.attrs[nodeId][this._id]||(Kinetic.Tween.attrs[nodeId][this._id]={}),Kinetic.Tween.tweens[nodeId]||(Kinetic.Tween.tweens[nodeId]={}),config)void 0===blacklist[key]&&this._addAttr(key,config[key]);this.reset(),this.onFinish=config.onFinish,this.onReset=config.onReset},Kinetic.Tween.attrs={},Kinetic.Tween.tweens={},Kinetic.Tween.prototype={_addAttr:function(key,end){var node=this.node,nodeId=node._id,start,diff,tweenId,n,len;if((tweenId=Kinetic.Tween.tweens[nodeId][key])&&delete Kinetic.Tween.attrs[nodeId][tweenId][key],start=node.getAttr(key),Kinetic.Util._isArray(end))for(diff=[],len=end.length,n=0;n<len;n++)diff.push(end[n]-start[n]);else diff=end-start;Kinetic.Tween.attrs[nodeId][this._id][key]={start:start,diff:diff},Kinetic.Tween.tweens[nodeId][key]=this._id},_tweenFunc:function(i){var node=this.node,attrs=Kinetic.Tween.attrs[node._id][this._id],key,attr,start,diff,newVal,n,len;for(key in attrs){if(start=(attr=attrs[key]).start,diff=attr.diff,Kinetic.Util._isArray(start))for(newVal=[],len=start.length,n=0;n<len;n++)newVal.push(start[n]+diff[n]*i);else newVal=start+diff*i;node.setAttr(key,newVal)}},_addListeners:function(){var that=this;this.tween.onPlay=function(){that.anim.start()},this.tween.onReverse=function(){that.anim.start()},this.tween.onPause=function(){that.anim.stop()},this.tween.onFinish=function(){that.onFinish&&that.onFinish()},this.tween.onReset=function(){that.onReset&&that.onReset()}},play:function(){return this.tween.play(),this},reverse:function(){return this.tween.reverse(),this},reset:function(){return this.tween.reset(),this},seek:function(t){return this.tween.seek(1e3*t),this},pause:function(){return this.tween.pause(),this},finish:function(){return this.tween.finish(),this},destroy:function(){var nodeId=this.node._id,thisId=this._id,attrs=Kinetic.Tween.tweens[nodeId],key;for(key in this.pause(),attrs)delete Kinetic.Tween.tweens[nodeId][key];delete Kinetic.Tween.attrs[nodeId][thisId]}};var Tween=function(prop,propFunc,func,begin,finish,duration,yoyo){this.prop=prop,this.propFunc=propFunc,this.begin=begin,this._pos=begin,this.duration=duration,this._change=0,this.prevPos=0,this.yoyo=yoyo,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.func=func,this._change=finish-this.begin,this.pause()};Tween.prototype={fire:function(str){var handler=this[str];handler&&handler()},setTime:function(t){t>this.duration?this.yoyo?(this._time=this.duration,this.reverse()):this.finish():t<0?this.yoyo?(this._time=0,this.play()):this.reset():(this._time=t,this.update())},getTime:function(){return this._time},setPosition:function(p){this.prevPos=this._pos,this.propFunc(p),this._pos=p},getPosition:function(t){return void 0===t&&(t=this._time),this.func(t,this.begin,this._change,this.duration)},play:function(){this.state=2,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onPlay")},reverse:function(){this.state=3,this._time=this.duration-this._time,this._startTime=this.getTimer()-this._time,this.onEnterFrame(),this.fire("onReverse")},seek:function(t){this.pause(),this._time=t,this.update(),this.fire("onSeek")},reset:function(){this.pause(),this._time=0,this.update(),this.fire("onReset")},finish:function(){this.pause(),this._time=this.duration,this.update(),this.fire("onFinish")},update:function(){this.setPosition(this.getPosition(this._time))},onEnterFrame:function(){var t=this.getTimer()-this._startTime;2===this.state?this.setTime(t):3===this.state&&this.setTime(this.duration-t)},pause:function(){this.state=1,this.fire("onPause")},getTimer:function(){return(new Date).getTime()}},Kinetic.Easings={BackEaseIn:function(t,b,c,d){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b},BackEaseOut:function(t,b,c,d){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},BackEaseInOut:function(t,b,c,d){var s=1.70158;return(t/=d/2)<1?c/2*(t*t*((1+(s*=1.525))*t-s))+b:c/2*((t-=2)*t*((1+(s*=1.525))*t+s)+2)+b},ElasticEaseIn:function(t,b,c,d,a,p){var s=0;return 0===t?b:1==(t/=d)?b+c:(p||(p=.3*d),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),-a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)+b)},ElasticEaseOut:function(t,b,c,d,a,p){var s=0;return 0===t?b:1==(t/=d)?b+c:(p||(p=.3*d),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b)},ElasticEaseInOut:function(t,b,c,d,a,p){var s=0;return 0===t?b:2==(t/=d/2)?b+c:(p||(p=d*(.3*1.5)),!a||a<Math.abs(c)?(a=c,s=p/4):s=p/(2*Math.PI)*Math.asin(c/a),t<1?a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*-.5+b:a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*.5+c+b)},BounceEaseOut:function(t,b,c,d){return(t/=d)<1/2.75?c*(7.5625*t*t)+b:t<2/2.75?c*(7.5625*(t-=1.5/2.75)*t+.75)+b:t<2.5/2.75?c*(7.5625*(t-=2.25/2.75)*t+.9375)+b:c*(7.5625*(t-=2.625/2.75)*t+.984375)+b},BounceEaseIn:function(t,b,c,d){return c-Kinetic.Easings.BounceEaseOut(d-t,0,c,d)+b},BounceEaseInOut:function(t,b,c,d){return t<d/2?.5*Kinetic.Easings.BounceEaseIn(2*t,0,c,d)+b:.5*Kinetic.Easings.BounceEaseOut(2*t-d,0,c,d)+.5*c+b},EaseIn:function(t,b,c,d){return c*(t/=d)*t+b},EaseOut:function(t,b,c,d){return-c*(t/=d)*(t-2)+b},EaseInOut:function(t,b,c,d){return(t/=d/2)<1?c/2*t*t+b:-c/2*(--t*(t-2)-1)+b},StrongEaseIn:function(t,b,c,d){return c*(t/=d)*t*t*t*t+b},StrongEaseOut:function(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b},StrongEaseInOut:function(t,b,c,d){return(t/=d/2)<1?c/2*t*t*t*t*t+b:c/2*((t-=2)*t*t*t*t+2)+b},Linear:function(t,b,c,d){return c*t/d+b}}}(),function(){Kinetic.DD={anim:new Kinetic.Animation((function(){var b=this.dirty;return this.dirty=!1,b})),isDragging:!1,justDragged:!1,offset:{x:0,y:0},node:null,_drag:function(evt){var dd=Kinetic.DD,node=dd.node;if(node){if(!dd.isDragging){var pos=node.getStage().getPointerPosition(),dragDistance=node.dragDistance(),distance;if(Math.max(Math.abs(pos.x-dd.startPointerPos.x),Math.abs(pos.y-dd.startPointerPos.y))<dragDistance)return}node._setDragPosition(evt),dd.isDragging||(dd.isDragging=!0,node.fire("dragstart",{type:"dragstart",target:node,evt:evt},!0)),node.fire("dragmove",{type:"dragmove",target:node,evt:evt},!0)}},_endDragBefore:function(evt){var dd=Kinetic.DD,node=dd.node,nodeType,layer;node&&(nodeType=node.nodeType,layer=node.getLayer(),dd.anim.stop(),dd.isDragging&&(dd.isDragging=!1,dd.justDragged=!0,Kinetic.listenClickTap=!1,evt&&(evt.dragEndNode=node)),delete dd.node,(layer||node).draw())},_endDragAfter:function(evt){var dragEndNode=(evt=evt||{}).dragEndNode;evt&&dragEndNode&&dragEndNode.fire("dragend",{type:"dragend",target:dragEndNode,evt:evt},!0)}},Kinetic.Node.prototype.startDrag=function(){var dd=Kinetic.DD,stage=this.getStage(),layer=this.getLayer(),pos=stage.getPointerPosition(),ap=this.getAbsolutePosition();pos&&(dd.node&&dd.node.stopDrag(),dd.node=this,dd.startPointerPos=pos,dd.offset.x=pos.x-ap.x,dd.offset.y=pos.y-ap.y,dd.anim.setLayers(layer||this.getLayers()),dd.anim.start(),this._setDragPosition())},Kinetic.Node.prototype._setDragPosition=function(evt){var dd=Kinetic.DD,pos=this.getStage().getPointerPosition(),dbf=this.getDragBoundFunc();if(pos){var newNodePos={x:pos.x-dd.offset.x,y:pos.y-dd.offset.y};void 0!==dbf&&(newNodePos=dbf.call(this,newNodePos,evt)),this.setAbsolutePosition(newNodePos),this._lastPos&&this._lastPos.x===newNodePos.x&&this._lastPos.y===newNodePos.y||(dd.anim.dirty=!0),this._lastPos=newNodePos}},Kinetic.Node.prototype.stopDrag=function(){var dd=Kinetic.DD,evt={};dd._endDragBefore(evt),dd._endDragAfter(evt)},Kinetic.Node.prototype.setDraggable=function(draggable){this._setAttr("draggable",draggable),this._dragChange()};var origDestroy=Kinetic.Node.prototype.destroy;Kinetic.Node.prototype.destroy=function(){var dd=Kinetic.DD;dd.node&&dd.node._id===this._id&&this.stopDrag(),origDestroy.call(this)},Kinetic.Node.prototype.isDragging=function(){var dd=Kinetic.DD;return!(!dd.node||dd.node._id!==this._id||!dd.isDragging)},Kinetic.Node.prototype._listenDrag=function(){var that=this;this._dragCleanup(),"Stage"===this.getClassName()?this.on("contentMousedown.kinetic contentTouchstart.kinetic",(function(evt){Kinetic.DD.node||that.startDrag(evt)})):this.on("mousedown.kinetic touchstart.kinetic",(function(evt){1!==evt.evt.button&&2!==evt.evt.button&&(Kinetic.DD.node||that.startDrag(evt))}))},Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var stage=this.getStage(),dd=Kinetic.DD;stage&&dd.node&&dd.node._id===this._id&&dd.node.stopDrag()}},Kinetic.Node.prototype._dragCleanup=function(){"Stage"===this.getClassName()?(this.off("contentMousedown.kinetic"),this.off("contentTouchstart.kinetic")):(this.off("mousedown.kinetic"),this.off("touchstart.kinetic"))},Kinetic.Factory.addGetterSetter(Kinetic.Node,"dragBoundFunc"),Kinetic.Factory.addGetter(Kinetic.Node,"draggable",!1),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Node,"draggable");var html=Kinetic.document.documentElement;html.addEventListener("mouseup",Kinetic.DD._endDragBefore,!0),html.addEventListener("touchend",Kinetic.DD._endDragBefore,!0),html.addEventListener("mouseup",Kinetic.DD._endDragAfter,!1),html.addEventListener("touchend",Kinetic.DD._endDragAfter,!1)}(),Kinetic.Util.addMethods(Kinetic.Container,{__init:function(config){this.children=new Kinetic.Collection,Kinetic.Node.call(this,config)},getChildren:function(filterFunc){if(filterFunc){var results=new Kinetic.Collection;return this.children.each((function(child){filterFunc(child)&&results.push(child)})),results}return this.children},hasChildren:function(){return this.getChildren().length>0},removeChildren:function(){for(var children=Kinetic.Collection.toCollection(this.children),child,i=0;i<children.length;i++)delete(child=children[i]).parent,child.index=0,child.hasChildren()&&child.removeChildren(),child.remove();return children=null,this.children=new Kinetic.Collection,this},destroyChildren:function(){for(var children=Kinetic.Collection.toCollection(this.children),child,i=0;i<children.length;i++)delete(child=children[i]).parent,child.index=0,child.destroy();return children=null,this.children=new Kinetic.Collection,this},add:function(child){if(arguments.length>1){for(var i=0;i<arguments.length;i++)this.add(arguments[i]);return this}if(child.getParent())return child.moveTo(this),this;var children=this.children;return this._validateAdd(child),child.index=children.length,child.parent=this,children.push(child),this._fire("add",{child:child}),child.isDragging()&&Kinetic.DD.anim.setLayers(child.getLayer()),this},destroy:function(){this.hasChildren()&&this.destroyChildren(),Kinetic.Node.prototype.destroy.call(this)},find:function(selector){var retArr=[],selectorArr=selector.replace(/ /g,"").split(","),len=selectorArr.length,n,i,sel,arr,node,children,clen;for(n=0;n<len;n++)if("#"===(sel=selectorArr[n]).charAt(0))(node=this._getNodeById(sel.slice(1)))&&retArr.push(node);else if("."===sel.charAt(0))arr=this._getNodesByName(sel.slice(1)),retArr=retArr.concat(arr);else for(clen=(children=this.getChildren()).length,i=0;i<clen;i++)retArr=retArr.concat(children[i]._get(sel));return Kinetic.Collection.toCollection(retArr)},_getNodeById:function(key){var node=Kinetic.ids[key];return void 0!==node&&this.isAncestorOf(node)?node:null},_getNodesByName:function(key){var arr=Kinetic.names[key]||[];return this._getDescendants(arr)},_get:function(selector){for(var retArr=Kinetic.Node.prototype._get.call(this,selector),children=this.getChildren(),len=children.length,n=0;n<len;n++)retArr=retArr.concat(children[n]._get(selector));return retArr},toObject:function(){var obj=Kinetic.Node.prototype.toObject.call(this);obj.children=[];for(var children=this.getChildren(),len=children.length,n=0;n<len;n++){var child=children[n];obj.children.push(child.toObject())}return obj},_getDescendants:function(arr){for(var retArr=[],len=arr.length,n=0;n<len;n++){var node=arr[n];this.isAncestorOf(node)&&retArr.push(node)}return retArr},isAncestorOf:function(node){for(var parent=node.getParent();parent;){if(parent._id===this._id)return!0;parent=parent.getParent()}return!1},clone:function(obj){var node=Kinetic.Node.prototype.clone.call(this,obj);return this.getChildren().each((function(no){node.add(no.clone())})),node},getAllIntersections:function(pos){var arr=[];return this.find("Shape").each((function(shape){shape.isVisible()&&shape.intersects(pos)&&arr.push(shape)})),arr},_setChildrenIndices:function(){this.children.each((function(child,n){child.index=n}))},drawScene:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas(),context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedSceneCanvas=cachedCanvas&&cachedCanvas.scene;return this.isVisible()&&(cachedSceneCanvas?this._drawCachedSceneCanvas(context):this._drawChildren(canvas,"drawScene",top)),this},drawHit:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas,context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;return this.shouldDrawHit(canvas)&&(layer&&layer.clearHitCache(),cachedHitCanvas?this._drawCachedHitCanvas(context):this._drawChildren(canvas,"drawHit",top)),this},_drawChildren:function(canvas,drawMethod,top){var layer=this.getLayer(),context=canvas&&canvas.getContext(),clipWidth=this.getClipWidth(),clipHeight=this.getClipHeight(),hasClip=clipWidth&&clipHeight,clipX,clipY;hasClip&&layer&&(clipX=this.getClipX(),clipY=this.getClipY(),context.save(),layer._applyTransform(this,context),context.beginPath(),context.rect(clipX,clipY,clipWidth,clipHeight),context.clip(),context.reset()),this.children.each((function(child){child[drawMethod](canvas,top)})),hasClip&&context.restore()},shouldDrawHit:function(canvas){var layer=this.getLayer(),dd,layerUnderDrag=Kinetic.DD&&Kinetic.isDragging()&&-1!==Kinetic.DD.anim.getLayers().indexOf(layer);return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isVisible()&&!layerUnderDrag}}),Kinetic.Util.extend(Kinetic.Container,Kinetic.Node),Kinetic.Container.prototype.get=Kinetic.Container.prototype.find,Kinetic.Factory.addComponentsGetterSetter(Kinetic.Container,"clip",["x","y","width","height"]),Kinetic.Factory.addGetterSetter(Kinetic.Container,"clipX"),Kinetic.Factory.addGetterSetter(Kinetic.Container,"clipY"),Kinetic.Factory.addGetterSetter(Kinetic.Container,"clipWidth"),Kinetic.Factory.addGetterSetter(Kinetic.Container,"clipHeight"),Kinetic.Collection.mapMethods(Kinetic.Container),function(){var HAS_SHADOW="hasShadow";function _fillFunc(context){context.fill()}function _strokeFunc(context){context.stroke()}function _fillFuncHit(context){context.fill()}function _strokeFuncHit(context){context.stroke()}function _clearHasShadowCache(){this._clearCache(HAS_SHADOW)}Kinetic.Util.addMethods(Kinetic.Shape,{__init:function(config){this.nodeType="Shape",this._fillFunc=_fillFunc,this._strokeFunc=_strokeFunc,this._fillFuncHit=_fillFuncHit,this._strokeFuncHit=_strokeFuncHit;for(var shapes=Kinetic.shapes,key;!(key=Kinetic.Util.getRandomColor())||key in shapes;);this.colorKey=key,shapes[key]=this,Kinetic.Node.call(this,config),this.on("shadowColorChange.kinetic shadowBlurChange.kinetic shadowOffsetChange.kinetic shadowOpacityChange.kinetic shadowEnabledChange.kinetic",_clearHasShadowCache)},hasChildren:function(){return!1},getChildren:function(){return[]},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return this._getCache(HAS_SHADOW,this._hasShadow)},_hasShadow:function(){return this.getShadowEnabled()&&0!==this.getShadowOpacity()&&!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY())},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops())},hasStroke:function(){return!!(this.stroke()||this.strokeRed()||this.strokeGreen()||this.strokeBlue())},intersects:function(point){var stage,bufferHitCanvas=this.getStage().bufferHitCanvas,p;return bufferHitCanvas.getContext().clear(),this.drawScene(bufferHitCanvas),(p=bufferHitCanvas.context.getImageData(Math.round(point.x),Math.round(point.y),1,1).data)[3]>0},destroy:function(){Kinetic.Node.prototype.destroy.call(this),delete Kinetic.shapes[this.colorKey]},_useBufferCanvas:function(){return(this.hasShadow()||1!==this.getAbsoluteOpacity())&&this.hasFill()&&this.hasStroke()&&this.getStage()},drawScene:function(can,top){var layer=this.getLayer(),canvas=can||layer.getCanvas(),context=canvas.getContext(),cachedCanvas=this._cache.canvas,drawFunc=this.sceneFunc(),hasShadow=this.hasShadow(),stage,bufferCanvas,bufferContext;if(this.isVisible())if(cachedCanvas)this._drawCachedSceneCanvas(context);else if(drawFunc){if(context.save(),this._useBufferCanvas()){if((bufferContext=(bufferCanvas=(stage=this.getStage()).bufferCanvas).getContext()).clear(),bufferContext.save(),bufferContext._applyLineJoin(this),layer)layer._applyTransform(this,bufferContext,top);else{var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}drawFunc.call(this,bufferContext),bufferContext.restore(),hasShadow&&!canvas.hitCanvas&&(context.save(),context._applyShadow(this),context.drawImage(bufferCanvas._canvas,0,0),context.restore()),context._applyOpacity(this),context.drawImage(bufferCanvas._canvas,0,0)}else{if(context._applyLineJoin(this),layer)layer._applyTransform(this,context,top);else{var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5])}hasShadow&&!canvas.hitCanvas&&(context.save(),context._applyShadow(this),drawFunc.call(this,context),context.restore()),context._applyOpacity(this),drawFunc.call(this,context)}context.restore()}return this},drawHit:function(can,top){var layer=this.getLayer(),canvas=can||layer.hitCanvas,context=canvas.getContext(),drawFunc=this.hitFunc()||this.sceneFunc(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(this.shouldDrawHit(canvas))if(layer&&layer.clearHitCache(),cachedHitCanvas)this._drawCachedHitCanvas(context);else if(drawFunc){if(context.save(),context._applyLineJoin(this),layer)layer._applyTransform(this,context,top);else{var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}drawFunc.call(this,context),context.restore()}return this},drawHitFromCache:function(alphaThreshold){var threshold=alphaThreshold||0,cachedCanvas=this._cache.canvas,sceneCanvas=this._getCachedSceneCanvas(),sceneContext=sceneCanvas.getContext(),hitCanvas,hitContext=cachedCanvas.hit.getContext(),width=sceneCanvas.getWidth(),height=sceneCanvas.getHeight(),sceneImageData,sceneData,hitImageData,hitData,len,rgbColorKey,i,alpha;hitContext.clear();try{for(sceneData=(sceneImageData=sceneContext.getImageData(0,0,width,height)).data,hitData=(hitImageData=hitContext.getImageData(0,0,width,height)).data,len=sceneData.length,rgbColorKey=Kinetic.Util._hexToRgb(this.colorKey),i=0;i<len;i+=4)(alpha=sceneData[i+3])>threshold&&(hitData[i]=rgbColorKey.r,hitData[i+1]=rgbColorKey.g,hitData[i+2]=rgbColorKey.b,hitData[i+3]=255);hitContext.putImageData(hitImageData,0,0)}catch(e){Kinetic.Util.warn("Unable to draw hit graph from cached scene canvas. "+e.message)}return this}}),Kinetic.Util.extend(Kinetic.Shape,Kinetic.Node),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"stroke"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeRed",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeGreen",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeBlue",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeAlpha",1,Kinetic.Validators.alphaComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeWidth",2),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"lineJoin"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"lineCap"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"sceneFunc"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"hitFunc"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"dash"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowColor"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowRed",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowGreen",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowBlue",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowAlpha",1,Kinetic.Validators.alphaComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowBlur"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowOpacity"),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"shadowOffset",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowOffsetX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowOffsetY",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternImage"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fill"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRed",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillGreen",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillBlue",0,Kinetic.Validators.RGBComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillAlpha",1,Kinetic.Validators.alphaComponent),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternY",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientColorStops"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartRadius",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndRadius",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientColorStops"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternRepeat","repeat"),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillEnabled",!0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeEnabled",!0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"shadowEnabled",!0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"dashEnabled",!0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"strokeScaleEnabled",!0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPriority","color"),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillPatternOffset",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternOffsetX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternOffsetY",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillPatternScale",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternScaleX",1),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternScaleY",1),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillLinearGradientStartPoint",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientStartPointX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientStartPointY",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillLinearGradientEndPoint",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientEndPointX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillLinearGradientEndPointY",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillRadialGradientStartPoint",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartPointX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientStartPointY",0),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Shape,"fillRadialGradientEndPoint",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndPointX",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillRadialGradientEndPointY",0),Kinetic.Factory.addGetterSetter(Kinetic.Shape,"fillPatternRotation",0),Kinetic.Factory.backCompat(Kinetic.Shape,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"}),Kinetic.Collection.mapMethods(Kinetic.Shape)}(),function(){var STAGE="Stage",STRING="string",PX="px",MOUSEOUT="mouseout",MOUSELEAVE="mouseleave",MOUSEOVER="mouseover",MOUSEENTER="mouseenter",MOUSEMOVE="mousemove",MOUSEDOWN="mousedown",MOUSEUP="mouseup",CLICK="click",DBL_CLICK="dblclick",TOUCHSTART="touchstart",TOUCHEND="touchend",TAP="tap",DBL_TAP="dbltap",TOUCHMOVE="touchmove",DOMMOUSESCROLL,MOUSEWHEEL="mousewheel",WHEEL,CONTENT_MOUSEOUT="contentMouseout",CONTENT_MOUSEOVER="contentMouseover",CONTENT_MOUSEMOVE="contentMousemove",CONTENT_MOUSEDOWN="contentMousedown",CONTENT_MOUSEUP="contentMouseup",CONTENT_CLICK="contentClick",CONTENT_DBL_CLICK="contentDblclick",CONTENT_TOUCHSTART="contentTouchstart",CONTENT_TOUCHEND="contentTouchend",CONTENT_DBL_TAP="contentDbltap",CONTENT_TOUCHMOVE="contentTouchmove",DIV="div",RELATIVE="relative",INLINE_BLOCK="inline-block",KINETICJS_CONTENT="kineticjs-content",SPACE=" ",UNDERSCORE="_",CONTAINER="container",EMPTY_STRING="",EVENTS=[MOUSEDOWN,MOUSEMOVE,MOUSEUP,MOUSEOUT,TOUCHSTART,TOUCHMOVE,TOUCHEND,MOUSEOVER,"DOMMouseScroll",MOUSEWHEEL,"wheel"],eventsLength=EVENTS.length;function addEvent(ctx,eventName){ctx.content.addEventListener(eventName,(function(evt){ctx["_"+eventName](evt)}),!1)}Kinetic.Util.addMethods(Kinetic.Stage,{___init:function(config){this.nodeType=STAGE,Kinetic.Container.call(this,config),this._id=Kinetic.idCounter++,this._buildDOM(),this._bindContentEvents(),this._enableNestedTransforms=!1,Kinetic.stages.push(this)},_validateAdd:function(child){"Layer"!==child.getType()&&Kinetic.Util.error("You may only add layers to the stage.")},setContainer:function(container){if(typeof container===STRING){var id=container;if(!(container=Kinetic.document.getElementById(container)))throw"Can not find container in document with id "+id}return this._setAttr(CONTAINER,container),this},shouldDrawHit:function(){return!0},draw:function(){return Kinetic.Node.prototype.draw.call(this),this},setHeight:function(height){return Kinetic.Node.prototype.setHeight.call(this,height),this._resizeDOM(),this},setWidth:function(width){return Kinetic.Node.prototype.setWidth.call(this,width),this._resizeDOM(),this},clear:function(){var layers=this.children,len=layers.length,n;for(n=0;n<len;n++)layers[n].clear();return this},clone:function(obj){return obj||(obj={}),obj.container=Kinetic.document.createElement(DIV),Kinetic.Container.prototype.clone.call(this,obj)},destroy:function(){var content=this.content;Kinetic.Container.prototype.destroy.call(this),content&&Kinetic.Util._isInDocument(content)&&this.getContainer().removeChild(content);var index=Kinetic.stages.indexOf(this);index>-1&&Kinetic.stages.splice(index,1)},getPointerPosition:function(){return this.pointerPos},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(config){var mimeType=(config=config||{}).mimeType||null,quality=config.quality||null,x=config.x||0,y=config.y||0,canvas=new Kinetic.SceneCanvas({width:config.width||this.getWidth(),height:config.height||this.getHeight(),pixelRatio:1}),_context=canvas.getContext()._context,layers=this.children;function drawLayer(n){var layer,layerUrl=layers[n].toDataURL(),imageObj=new Kinetic.window.Image;imageObj.onload=function(){_context.drawImage(imageObj,0,0),n<layers.length-1?drawLayer(n+1):config.callback(canvas.toDataURL(mimeType,quality))},imageObj.src=layerUrl}(x||y)&&_context.translate(-1*x,-1*y),drawLayer(0)},toImage:function(config){var cb=config.callback;config.callback=function(dataUrl){Kinetic.Util._getImage(dataUrl,(function(img){cb(img)}))},this.toDataURL(config)},getIntersection:function(pos){var layers=this.getChildren(),len,end,n,shape;for(n=layers.length-1;n>=0;n--)if(shape=layers[n].getIntersection(pos))return shape;return null},_resizeDOM:function(){if(this.content){var width=this.getWidth(),height=this.getHeight(),layers=this.getChildren(),len=layers.length,n,layer;for(this.content.style.width=width+PX,this.content.style.height=height+PX,this.bufferCanvas.setSize(width,height),this.bufferHitCanvas.setSize(width,height),n=0;n<len;n++)(layer=layers[n]).setSize(width,height),layer.draw()}},add:function(layer){if(!(arguments.length>1))return Kinetic.Container.prototype.add.call(this,layer),layer._setCanvasSize(this.width(),this.height()),layer.draw(),this.content.appendChild(layer.canvas._canvas),this;for(var i=0;i<arguments.length;i++)this.add(arguments[i])},getParent:function(){return null},getLayer:function(){return null},getLayers:function(){return this.getChildren()},_bindContentEvents:function(){for(var n=0;n<eventsLength;n++)addEvent(this,EVENTS[n])},_mouseover:function(evt){Kinetic.UA.mobile||(this._setPointerPosition(evt),this._fire(CONTENT_MOUSEOVER,{evt:evt}))},_mouseout:function(evt){if(!Kinetic.UA.mobile){this._setPointerPosition(evt);var targetShape=this.targetShape;targetShape&&!Kinetic.isDragging()&&(targetShape._fireAndBubble(MOUSEOUT,{evt:evt}),targetShape._fireAndBubble(MOUSELEAVE,{evt:evt}),this.targetShape=null),this.pointerPos=void 0,this._fire(CONTENT_MOUSEOUT,{evt:evt})}},_mousemove:function(evt){if(Kinetic.UA.ieMobile)return this._touchmove(evt);if((void 0===evt.webkitMovementX&&void 0===evt.webkitMovementY||0!==evt.webkitMovementY||0!==evt.webkitMovementX)&&!Kinetic.UA.mobile){this._setPointerPosition(evt);var dd=Kinetic.DD,shape;Kinetic.isDragging()||((shape=this.getIntersection(this.getPointerPosition()))&&shape.isListening()?Kinetic.isDragging()||this.targetShape&&this.targetShape._id===shape._id?shape._fireAndBubble(MOUSEMOVE,{evt:evt}):(this.targetShape&&(this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt},shape),this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt},shape)),shape._fireAndBubble(MOUSEOVER,{evt:evt},this.targetShape),shape._fireAndBubble(MOUSEENTER,{evt:evt},this.targetShape),this.targetShape=shape):this.targetShape&&!Kinetic.isDragging()&&(this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt}),this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt}),this.targetShape=null),this._fire(CONTENT_MOUSEMOVE,{evt:evt})),dd&&dd._drag(evt),evt.preventDefault&&evt.preventDefault()}},_mousedown:function(evt){if(Kinetic.UA.ieMobile)return this._touchstart(evt);if(!Kinetic.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Kinetic.listenClickTap=!0,shape&&shape.isListening()&&(this.clickStartShape=shape,shape._fireAndBubble(MOUSEDOWN,{evt:evt})),this._fire(CONTENT_MOUSEDOWN,{evt:evt})}evt.preventDefault&&evt.preventDefault()},_mouseup:function(evt){if(Kinetic.UA.ieMobile)return this._touchend(evt);if(!Kinetic.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),clickStartShape=this.clickStartShape,fireDblClick=!1,dd=Kinetic.DD;Kinetic.inDblClickWindow?(fireDblClick=!0,Kinetic.inDblClickWindow=!1):dd&&dd.justDragged?dd&&(dd.justDragged=!1):Kinetic.inDblClickWindow=!0,setTimeout((function(){Kinetic.inDblClickWindow=!1}),Kinetic.dblClickWindow),shape&&shape.isListening()&&(shape._fireAndBubble(MOUSEUP,{evt:evt}),Kinetic.listenClickTap&&clickStartShape&&clickStartShape._id===shape._id&&(shape._fireAndBubble(CLICK,{evt:evt}),fireDblClick&&shape._fireAndBubble(DBL_CLICK,{evt:evt}))),this._fire(CONTENT_MOUSEUP,{evt:evt}),Kinetic.listenClickTap&&(this._fire(CONTENT_CLICK,{evt:evt}),fireDblClick&&this._fire("contentDblclick",{evt:evt})),Kinetic.listenClickTap=!1}evt.preventDefault&&evt.preventDefault()},_touchstart:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Kinetic.listenClickTap=!0,shape&&shape.isListening()&&(this.tapStartShape=shape,shape._fireAndBubble(TOUCHSTART,{evt:evt}),shape.isListening()&&evt.preventDefault&&evt.preventDefault()),this._fire(CONTENT_TOUCHSTART,{evt:evt})},_touchend:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),fireDblClick=!1;Kinetic.inDblClickWindow?(fireDblClick=!0,Kinetic.inDblClickWindow=!1):Kinetic.inDblClickWindow=!0,setTimeout((function(){Kinetic.inDblClickWindow=!1}),Kinetic.dblClickWindow),shape&&shape.isListening()&&(shape._fireAndBubble(TOUCHEND,{evt:evt}),Kinetic.listenClickTap&&shape._id===this.tapStartShape._id&&(shape._fireAndBubble(TAP,{evt:evt}),fireDblClick&&shape._fireAndBubble(DBL_TAP,{evt:evt})),shape.isListening()&&evt.preventDefault&&evt.preventDefault()),Kinetic.listenClickTap&&(this._fire(CONTENT_TOUCHEND,{evt:evt}),fireDblClick&&this._fire("contentDbltap",{evt:evt})),Kinetic.listenClickTap=!1},_touchmove:function(evt){this._setPointerPosition(evt);var dd=Kinetic.DD,shape;Kinetic.isDragging()||((shape=this.getIntersection(this.getPointerPosition()))&&shape.isListening()&&(shape._fireAndBubble(TOUCHMOVE,{evt:evt}),shape.isListening()&&evt.preventDefault&&evt.preventDefault()),this._fire(CONTENT_TOUCHMOVE,{evt:evt})),dd&&(dd._drag(evt),Kinetic.isDragging()&&evt.preventDefault())},_DOMMouseScroll:function(evt){this._mousewheel(evt)},_mousewheel:function(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());shape&&shape.isListening()&&shape._fireAndBubble(MOUSEWHEEL,{evt:evt})},_wheel:function(evt){this._mousewheel(evt)},_setPointerPosition:function(evt){var contentPosition=this._getContentPosition(),offsetX=evt.offsetX,clientX=evt.clientX,x=null,y=null,touch;void 0!==(evt=evt||window.event).touches?evt.touches.length>0&&(x=(touch=evt.touches[0]).clientX-contentPosition.left,y=touch.clientY-contentPosition.top):void 0!==offsetX?(x=offsetX,y=evt.offsetY):"mozilla"===Kinetic.UA.browser?(x=evt.layerX,y=evt.layerY):void 0!==clientX&&contentPosition&&(x=clientX-contentPosition.left,y=evt.clientY-contentPosition.top),null!==x&&null!==y&&(this.pointerPos={x:x,y:y})},_getContentPosition:function(){var rect=this.content.getBoundingClientRect?this.content.getBoundingClientRect():{top:0,left:0};return{top:rect.top,left:rect.left}},_buildDOM:function(){var container=this.getContainer();if(!container){if(Kinetic.Util.isBrowser())throw"Stage has no container. A container is required.";container=Kinetic.document.createElement(DIV)}container.innerHTML="",this.content=Kinetic.document.createElement(DIV),this.content.style.position=RELATIVE,this.content.style.display=INLINE_BLOCK,this.content.className=KINETICJS_CONTENT,this.content.setAttribute("role","presentation"),container.appendChild(this.content),this.bufferCanvas=new Kinetic.SceneCanvas({pixelRatio:1}),this.bufferHitCanvas=new Kinetic.HitCanvas,this._resizeDOM()},_onContent:function(typesStr,handler){var types=typesStr.split(" "),len=types.length,n,baseEvent;for(n=0;n<len;n++)baseEvent=types[n],this.content.addEventListener(baseEvent,handler,!1)},cache:function(){Kinetic.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.")},clearCache:function(){}}),Kinetic.Util.extend(Kinetic.Stage,Kinetic.Container),Kinetic.Factory.addGetter(Kinetic.Stage,"container"),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Stage,"container")}(),Kinetic.Util.addMethods(Kinetic.BaseLayer,{___init:function(config){this.nodeType="Layer",Kinetic.Container.call(this,config)},createPNGStream:function(){return this.canvas._canvas.createPNGStream()},getCanvas:function(){return this.canvas},getHitCanvas:function(){return this.hitCanvas},getContext:function(){return this.getCanvas().getContext()},clear:function(bounds){return this.getContext().clear(bounds),this.getHitCanvas().getContext().clear(bounds),this},clearHitCache:function(){this._hitImageData=void 0},setZIndex:function(index){Kinetic.Node.prototype.setZIndex.call(this,index);var stage=this.getStage();return stage&&(stage.content.removeChild(this.getCanvas()._canvas),index<stage.getChildren().length-1?stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[index+1].getCanvas()._canvas):stage.content.appendChild(this.getCanvas()._canvas)),this},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var stage=this.getStage();stage&&(stage.content.removeChild(this.getCanvas()._canvas),stage.content.appendChild(this.getCanvas()._canvas))},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var stage=this.getStage();stage&&(stage.content.removeChild(this.getCanvas()._canvas),this.index<stage.getChildren().length-1?stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[this.index+1].getCanvas()._canvas):stage.content.appendChild(this.getCanvas()._canvas))}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas),stage.content.insertBefore(this.getCanvas()._canvas,children[this.index+1].getCanvas()._canvas)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas),stage.content.insertBefore(this.getCanvas()._canvas,children[1].getCanvas()._canvas)}}},getLayer:function(){return this},remove:function(){var _canvas=this.getCanvas()._canvas;return Kinetic.Node.prototype.remove.call(this),_canvas&&_canvas.parentNode&&Kinetic.Util._isInDocument(_canvas)&&_canvas.parentNode.removeChild(_canvas),this},getStage:function(){return this.parent},setSize:function(width,height){this.canvas.setSize(width,height)},getWidth:function(){if(this.parent)return this.parent.getWidth()},setWidth:function(){Kinetic.Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.')},getHeight:function(){if(this.parent)return this.parent.getHeight()},setHeight:function(){Kinetic.Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.')}}),Kinetic.Util.extend(Kinetic.BaseLayer,Kinetic.Container),Kinetic.Factory.addGetterSetter(Kinetic.BaseLayer,"clearBeforeDraw",!0),Kinetic.Collection.mapMethods(Kinetic.BaseLayer),function(){var HASH="#",BEFORE_DRAW="beforeDraw",DRAW="draw",INTERSECTION_OFFSETS=[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1}],INTERSECTION_OFFSETS_LEN=INTERSECTION_OFFSETS.length;Kinetic.Util.addMethods(Kinetic.Layer,{____init:function(config){this.nodeType="Layer",this.canvas=new Kinetic.SceneCanvas,this.hitCanvas=new Kinetic.HitCanvas,Kinetic.BaseLayer.call(this,config)},_setCanvasSize:function(width,height){this.canvas.setSize(width,height),this.hitCanvas.setSize(width,height)},_validateAdd:function(child){var type=child.getType();"Group"!==type&&"Shape"!==type&&Kinetic.Util.error("You may only add groups and shapes to a layer.")},getIntersection:function(pos){var obj,i,intersectionOffset,shape;if(!this.hitGraphEnabled()||!this.isVisible())return null;for(var spiralSearchDistance=1,continueSearch=!1;;){for(i=0;i<INTERSECTION_OFFSETS_LEN;i++){if(intersectionOffset=INTERSECTION_OFFSETS[i],shape=(obj=this._getIntersection({x:pos.x+intersectionOffset.x*spiralSearchDistance,y:pos.y+intersectionOffset.y*spiralSearchDistance})).shape)return shape;obj.antialiased&&(continueSearch=!0)}if(!continueSearch)return;spiralSearchDistance+=1}},_getImageData:function(x,y){var width=this.hitCanvas.width||1,height=this.hitCanvas.height||1,index=Math.round(y)*width+Math.round(x);return this._hitImageData||(this._hitImageData=this.hitCanvas.context.getImageData(0,0,width,height)),[this._hitImageData.data[4*index+0],this._hitImageData.data[4*index+1],this._hitImageData.data[4*index+2],this._hitImageData.data[4*index+3]]},_getIntersection:function(pos){var p=this.hitCanvas.context.getImageData(pos.x,pos.y,1,1).data,p3=p[3],colorKey,shape;return 255===p3?(colorKey=Kinetic.Util._rgbToHex(p[0],p[1],p[2]),{shape:shape=Kinetic.shapes["#"+colorKey]}):p3>0?{antialiased:!0}:{}},drawScene:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();return this._fire(BEFORE_DRAW,{node:this}),this.getClearBeforeDraw()&&canvas.getContext().clear(),Kinetic.Container.prototype.drawScene.call(this,canvas,top),this._fire(DRAW,{node:this}),this},_applyTransform:function(shape,context,top){var m=shape.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])},drawHit:function(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas;return layer&&layer.getClearBeforeDraw()&&layer.getHitCanvas().getContext().clear(),Kinetic.Container.prototype.drawHit.call(this,canvas,top),this.imageData=null,this},clear:function(bounds){return this.getContext().clear(bounds),this.getHitCanvas().getContext().clear(bounds),this.imageData=null,this},setVisible:function(visible){return Kinetic.Node.prototype.setVisible.call(this,visible),visible?(this.getCanvas()._canvas.style.display="block",this.hitCanvas._canvas.style.display="block"):(this.getCanvas()._canvas.style.display="none",this.hitCanvas._canvas.style.display="none"),this},enableHitGraph:function(){return this.setHitGraphEnabled(!0),this},disableHitGraph:function(){return this.setHitGraphEnabled(!1),this},setSize:function(width,height){Kinetic.BaseLayer.prototype.setSize.call(this,width,height),this.hitCanvas.setSize(width,height)}}),Kinetic.Util.extend(Kinetic.Layer,Kinetic.BaseLayer),Kinetic.Factory.addGetterSetter(Kinetic.Layer,"hitGraphEnabled",!0),Kinetic.Collection.mapMethods(Kinetic.Layer)}(),Kinetic.Util.addMethods(Kinetic.FastLayer,{____init:function(config){this.nodeType="Layer",this.canvas=new Kinetic.SceneCanvas,Kinetic.BaseLayer.call(this,config)},_validateAdd:function(child){var type;"Shape"!==child.getType()&&Kinetic.Util.error("You may only add shapes to a fast layer.")},_setCanvasSize:function(width,height){this.canvas.setSize(width,height)},hitGraphEnabled:function(){return!1},getIntersection:function(){return null},drawScene:function(can){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();return this.getClearBeforeDraw()&&canvas.getContext().clear(),Kinetic.Container.prototype.drawScene.call(this,canvas),this},_applyTransform:function(shape,context,top){if(!top||top._id!==this._id){var m=shape.getTransform().getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5])}},draw:function(){return this.drawScene(),this},clear:function(bounds){return this.getContext().clear(bounds),this},setVisible:function(visible){return Kinetic.Node.prototype.setVisible.call(this,visible),this.getCanvas()._canvas.style.display=visible?"block":"none",this}}),Kinetic.Util.extend(Kinetic.FastLayer,Kinetic.BaseLayer),Kinetic.Collection.mapMethods(Kinetic.FastLayer),Kinetic.Util.addMethods(Kinetic.Group,{___init:function(config){this.nodeType="Group",Kinetic.Container.call(this,config)},_validateAdd:function(child){var type=child.getType();"Group"!==type&&"Shape"!==type&&Kinetic.Util.error("You may only add groups and shapes to groups.")}}),Kinetic.Util.extend(Kinetic.Group,Kinetic.Container),Kinetic.Collection.mapMethods(Kinetic.Group),Kinetic.Rect=function(config){this.___init(config)},Kinetic.Rect.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Rect",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var cornerRadius=this.getCornerRadius(),width=this.getWidth(),height=this.getHeight();context.beginPath(),cornerRadius?(context.moveTo(cornerRadius,0),context.lineTo(width-cornerRadius,0),context.arc(width-cornerRadius,cornerRadius,cornerRadius,3*Math.PI/2,0,!1),context.lineTo(width,height-cornerRadius),context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,!1),context.lineTo(cornerRadius,height),context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,!1),context.lineTo(0,cornerRadius),context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,3*Math.PI/2,!1)):context.rect(0,0,width,height),context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.Rect,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Rect,"cornerRadius",0),Kinetic.Collection.mapMethods(Kinetic.Rect),function(){var PIx2=2*Math.PI-1e-4,CIRCLE="Circle";Kinetic.Circle=function(config){this.___init(config)},Kinetic.Circle.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className=CIRCLE,this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath(),context.arc(0,0,this.getRadius(),0,PIx2,!1),context.closePath(),context.fillStrokeShape(this)},getWidth:function(){return 2*this.getRadius()},getHeight:function(){return 2*this.getRadius()},setWidth:function(width){Kinetic.Node.prototype.setWidth.call(this,width),this.radius()!==width/2&&this.setRadius(width/2)},setHeight:function(height){Kinetic.Node.prototype.setHeight.call(this,height),this.radius()!==height/2&&this.setRadius(height/2)},setRadius:function(val){this._setAttr("radius",val),this.setWidth(2*val),this.setHeight(2*val)}},Kinetic.Util.extend(Kinetic.Circle,Kinetic.Shape),Kinetic.Factory.addGetter(Kinetic.Circle,"radius",0),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Circle,"radius"),Kinetic.Collection.mapMethods(Kinetic.Circle)}(),function(){var PIx2=2*Math.PI-1e-4,ELLIPSE="Ellipse";Kinetic.Ellipse=function(config){this.___init(config)},Kinetic.Ellipse.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className=ELLIPSE,this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var rx=this.getRadiusX(),ry=this.getRadiusY();context.beginPath(),context.save(),rx!==ry&&context.scale(1,ry/rx),context.arc(0,0,rx,0,PIx2,!1),context.restore(),context.closePath(),context.fillStrokeShape(this)},getWidth:function(){return 2*this.getRadiusX()},getHeight:function(){return 2*this.getRadiusY()},setWidth:function(width){Kinetic.Node.prototype.setWidth.call(this,width),this.setRadius({x:width/2})},setHeight:function(height){Kinetic.Node.prototype.setHeight.call(this,height),this.setRadius({y:height/2})}},Kinetic.Util.extend(Kinetic.Ellipse,Kinetic.Shape),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Ellipse,"radius",["x","y"]),Kinetic.Factory.addGetterSetter(Kinetic.Ellipse,"radiusX",0),Kinetic.Factory.addGetterSetter(Kinetic.Ellipse,"radiusY",0),Kinetic.Collection.mapMethods(Kinetic.Ellipse)}(),function(){var PIx2=2*Math.PI-1e-4;Kinetic.Ring=function(config){this.___init(config)},Kinetic.Ring.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Ring",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath(),context.arc(0,0,this.getInnerRadius(),0,PIx2,!1),context.moveTo(this.getOuterRadius(),0),context.arc(0,0,this.getOuterRadius(),PIx2,0,!0),context.closePath(),context.fillStrokeShape(this)},getWidth:function(){return 2*this.getOuterRadius()},getHeight:function(){return 2*this.getOuterRadius()},setWidth:function(width){Kinetic.Node.prototype.setWidth.call(this,width),this.outerRadius()!==width/2&&this.setOuterRadius(width/2)},setHeight:function(height){Kinetic.Node.prototype.setHeight.call(this,height),this.outerRadius()!==height/2&&this.setOuterRadius(height/2)},setOuterRadius:function(val){this._setAttr("outerRadius",val),this.setWidth(2*val),this.setHeight(2*val)}},Kinetic.Util.extend(Kinetic.Ring,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Ring,"innerRadius",0),Kinetic.Factory.addGetter(Kinetic.Ring,"outerRadius",0),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Ring,"outerRadius"),Kinetic.Collection.mapMethods(Kinetic.Ring)}(),Kinetic.Wedge=function(config){this.___init(config)},Kinetic.Wedge.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Wedge",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.beginPath(),context.arc(0,0,this.getRadius(),0,Kinetic.getAngle(this.getAngle()),this.getClockwise()),context.lineTo(0,0),context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.Wedge,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Wedge,"radius",0),Kinetic.Factory.addGetterSetter(Kinetic.Wedge,"angle",0),Kinetic.Factory.addGetterSetter(Kinetic.Wedge,"clockwise",!1),Kinetic.Factory.backCompat(Kinetic.Wedge,{angleDeg:"angle",getAngleDeg:"getAngle",setAngleDeg:"setAngle"}),Kinetic.Collection.mapMethods(Kinetic.Wedge),Kinetic.Arc=function(config){this.___init(config)},Kinetic.Arc.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Arc",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var angle=Kinetic.getAngle(this.angle()),clockwise=this.clockwise();context.beginPath(),context.arc(0,0,this.getOuterRadius(),0,angle,clockwise),context.arc(0,0,this.getInnerRadius(),angle,0,!clockwise),context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.Arc,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Arc,"innerRadius",0),Kinetic.Factory.addGetterSetter(Kinetic.Arc,"outerRadius",0),Kinetic.Factory.addGetterSetter(Kinetic.Arc,"angle",0),Kinetic.Factory.addGetterSetter(Kinetic.Arc,"clockwise",!1),Kinetic.Collection.mapMethods(Kinetic.Arc),function(){var IMAGE="Image";Kinetic.Image=function(config){this.___init(config)},Kinetic.Image.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className=IMAGE,this.sceneFunc(this._sceneFunc),this.hitFunc(this._hitFunc)},_useBufferCanvas:function(){return(this.hasShadow()||1!==this.getAbsoluteOpacity())&&this.hasStroke()&&this.getStage()},_sceneFunc:function(context){var width=this.getWidth(),height=this.getHeight(),image=this.getImage(),cropWidth,cropHeight,params;image&&(cropWidth=this.getCropWidth(),cropHeight=this.getCropHeight(),params=cropWidth&&cropHeight?[image,this.getCropX(),this.getCropY(),cropWidth,cropHeight,0,0,width,height]:[image,0,0,width,height]),(this.hasFill()||this.hasStroke()||this.hasShadow())&&(context.beginPath(),context.rect(0,0,width,height),context.closePath(),context.fillStrokeShape(this)),image&&context.drawImage.apply(context,params)},_hitFunc:function(context){var width=this.getWidth(),height=this.getHeight();context.beginPath(),context.rect(0,0,width,height),context.closePath(),context.fillStrokeShape(this)},getWidth:function(){var image=this.getImage();return this.attrs.width||(image?image.width:0)},getHeight:function(){var image=this.getImage();return this.attrs.height||(image?image.height:0)}},Kinetic.Util.extend(Kinetic.Image,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Image,"image"),Kinetic.Factory.addComponentsGetterSetter(Kinetic.Image,"crop",["x","y","width","height"]),Kinetic.Factory.addGetterSetter(Kinetic.Image,"cropX",0),Kinetic.Factory.addGetterSetter(Kinetic.Image,"cropY",0),Kinetic.Factory.addGetterSetter(Kinetic.Image,"cropWidth",0),Kinetic.Factory.addGetterSetter(Kinetic.Image,"cropHeight",0),Kinetic.Collection.mapMethods(Kinetic.Image)}(),function(){var AUTO="auto",CENTER="center",CHANGE_KINETIC="Change.kinetic",CONTEXT_2D="2d",DASH="-",EMPTY_STRING="",LEFT="left",TEXT="text",TEXT_UPPER="Text",MIDDLE="middle",NORMAL="normal",PX_SPACE="px ",SPACE=" ",RIGHT="right",WORD="word",CHAR="char",NONE="none",ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","fontVariant","padding","align","lineHeight","text","width","height","wrap"],attrChangeListLen=ATTR_CHANGE_LIST.length,dummyContext=Kinetic.Util.createCanvasElement().getContext("2d");function _fillFunc(context){context.fillText(this.partialText,0,0)}function _strokeFunc(context){context.strokeText(this.partialText,0,0)}Kinetic.Text=function(config){this.___init(config)},Kinetic.Text.prototype={___init:function(config){(config=config||{}).fill=config.fill||"black",void 0===config.width&&(config.width=AUTO),void 0===config.height&&(config.height=AUTO),Kinetic.Shape.call(this,config),this._fillFunc=_fillFunc,this._strokeFunc=_strokeFunc,this.className="Text";for(var n=0;n<attrChangeListLen;n++)this.on(ATTR_CHANGE_LIST[n]+CHANGE_KINETIC,this._setTextData);this._setTextData(),this.sceneFunc(this._sceneFunc),this.hitFunc(this._hitFunc)},_sceneFunc:function(context){var p=this.getPadding(),textHeight=this.getTextHeight(),lineHeightPx=this.getLineHeight()*textHeight,textArr=this.textArr,textArrLen=textArr.length,totalWidth=this.getWidth(),n;for(context.setAttr("font",this._getContextFont()),context.setAttr("textBaseline",MIDDLE),context.setAttr("textAlign",LEFT),context.save(),context.translate(p,0),context.translate(0,p+textHeight/2),n=0;n<textArrLen;n++){var obj=textArr[n],text=obj.text,width=obj.width;context.save(),this.getAlign()===RIGHT?context.translate(totalWidth-width-2*p,0):this.getAlign()===CENTER&&context.translate((totalWidth-width-2*p)/2,0),this.partialText=text,context.fillStrokeShape(this),context.restore(),context.translate(0,lineHeightPx)}context.restore()},_hitFunc:function(context){var width=this.getWidth(),height=this.getHeight();context.beginPath(),context.rect(0,0,width,height),context.closePath(),context.fillStrokeShape(this)},setText:function(text){var str=Kinetic.Util._isString(text)?text:text.toString();return this._setAttr(TEXT,str),this},getWidth:function(){return this.attrs.width===AUTO?this.getTextWidth()+2*this.getPadding():this.attrs.width},getHeight:function(){return this.attrs.height===AUTO?this.getTextHeight()*this.textArr.length*this.getLineHeight()+2*this.getPadding():this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(text){var _context=dummyContext,fontSize=this.getFontSize(),metrics;return _context.save(),_context.font=this._getContextFont(),metrics=_context.measureText(text),_context.restore(),{width:metrics.width,height:parseInt(fontSize,10)}},_getContextFont:function(){return this.getFontStyle()+" "+this.getFontVariant()+" "+this.getFontSize()+"px "+this.getFontFamily()},_addTextLine:function(line,width){return this.textArr.push({text:line,width:width})},_getTextWidth:function(text){return dummyContext.measureText(text).width},_setTextData:function(){var lines=this.getText().split("\n"),fontSize=+this.getFontSize(),textWidth=0,lineHeightPx=this.getLineHeight()*fontSize,width=this.attrs.width,height=this.attrs.height,fixedWidth=width!==AUTO,fixedHeight=height!==AUTO,padding=this.getPadding(),maxWidth=width-2*padding,maxHeightPx=height-2*padding,currentHeightPx=0,wrap=this.getWrap(),shouldWrap=wrap!==NONE,wrapAtWord=wrap!==CHAR&&shouldWrap;this.textArr=[],dummyContext.save(),dummyContext.font=this._getContextFont();for(var i=0,max=lines.length;i<max;++i){var line=lines[i],lineWidth=this._getTextWidth(line);if(fixedWidth&&lineWidth>maxWidth)for(;line.length>0;){for(var low=0,high=line.length,match="",matchWidth=0;low<high;){var mid=low+high>>>1,substr=line.slice(0,mid+1),substrWidth=this._getTextWidth(substr);substrWidth<=maxWidth?(low=mid+1,match=substr,matchWidth=substrWidth):high=mid}if(!match)break;if(wrapAtWord){var wrapIndex=Math.max(match.lastIndexOf(" "),match.lastIndexOf("-"))+1;wrapIndex>0&&(low=wrapIndex,match=match.slice(0,low),matchWidth=this._getTextWidth(match))}if(this._addTextLine(match,matchWidth),textWidth=Math.max(textWidth,matchWidth),currentHeightPx+=lineHeightPx,!shouldWrap||fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx)break;if((line=line.slice(low)).length>0&&(lineWidth=this._getTextWidth(line))<=maxWidth){this._addTextLine(line,lineWidth),currentHeightPx+=lineHeightPx,textWidth=Math.max(textWidth,lineWidth);break}}else this._addTextLine(line,lineWidth),currentHeightPx+=lineHeightPx,textWidth=Math.max(textWidth,lineWidth);if(fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx)break}dummyContext.restore(),this.textHeight=fontSize,this.textWidth=textWidth}},Kinetic.Util.extend(Kinetic.Text,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontFamily","Arial"),Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontSize",12),Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontStyle",NORMAL),Kinetic.Factory.addGetterSetter(Kinetic.Text,"fontVariant",NORMAL),Kinetic.Factory.addGetterSetter(Kinetic.Text,"padding",0),Kinetic.Factory.addGetterSetter(Kinetic.Text,"align",LEFT),Kinetic.Factory.addGetterSetter(Kinetic.Text,"lineHeight",1),Kinetic.Factory.addGetterSetter(Kinetic.Text,"wrap",WORD),Kinetic.Factory.addGetter(Kinetic.Text,"text",""),Kinetic.Factory.addOverloadedGetterSetter(Kinetic.Text,"text"),Kinetic.Collection.mapMethods(Kinetic.Text)}(),Kinetic.Line=function(config){this.___init(config)},Kinetic.Line.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Line",this.on("pointsChange.kinetic tensionChange.kinetic closedChange.kinetic",(function(){this._clearCache("tensionPoints")})),this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var points=this.getPoints(),length=points.length,tension=this.getTension(),closed=this.getClosed(),tp,len,n;if(length){if(context.beginPath(),context.moveTo(points[0],points[1]),0!==tension&&length>4){for(len=(tp=this.getTensionPoints()).length,n=closed?0:4,closed||context.quadraticCurveTo(tp[0],tp[1],tp[2],tp[3]);n<len-2;)context.bezierCurveTo(tp[n++],tp[n++],tp[n++],tp[n++],tp[n++],tp[n++]);closed||context.quadraticCurveTo(tp[len-2],tp[len-1],points[length-2],points[length-1])}else for(n=2;n<length;n+=2)context.lineTo(points[n],points[n+1]);closed?(context.closePath(),context.fillStrokeShape(this)):context.strokeShape(this)}},getTensionPoints:function(){return this._getCache("tensionPoints",this._getTensionPoints)},_getTensionPoints:function(){return this.getClosed()?this._getTensionPointsClosed():Kinetic.Util._expandPoints(this.getPoints(),this.getTension())},_getTensionPointsClosed:function(){var p=this.getPoints(),len=p.length,tension=this.getTension(),util=Kinetic.Util,firstControlPoints=util._getControlPoints(p[len-2],p[len-1],p[0],p[1],p[2],p[3],tension),lastControlPoints=util._getControlPoints(p[len-4],p[len-3],p[len-2],p[len-1],p[0],p[1],tension),middle=Kinetic.Util._expandPoints(p,tension),tp;return[firstControlPoints[2],firstControlPoints[3]].concat(middle).concat([lastControlPoints[0],lastControlPoints[1],p[len-2],p[len-1],lastControlPoints[2],lastControlPoints[3],firstControlPoints[0],firstControlPoints[1],p[0],p[1]])}},Kinetic.Util.extend(Kinetic.Line,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Line,"closed",!1),Kinetic.Factory.addGetterSetter(Kinetic.Line,"tension",0),Kinetic.Factory.addGetterSetter(Kinetic.Line,"points",[]),Kinetic.Collection.mapMethods(Kinetic.Line),Kinetic.Sprite=function(config){this.___init(config)},Kinetic.Sprite.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Sprite",this._updated=!0;var that=this;this.anim=new Kinetic.Animation((function(){var updated=that._updated;return that._updated=!1,updated})),this.on("animationChange.kinetic",(function(){this.frameIndex(0)})),this.on("frameIndexChange.kinetic",(function(){this._updated=!0})),this.on("frameRateChange.kinetic",(function(){this.anim.isRunning()&&(clearInterval(this.interval),this._setInterval())})),this.sceneFunc(this._sceneFunc),this.hitFunc(this._hitFunc)},_sceneFunc:function(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=4*index,set=this.getAnimations()[anim],offsets=this.frameOffsets(),x=set[ix4+0],y=set[ix4+1],width=set[ix4+2],height=set[ix4+3],image=this.getImage();if(image)if(offsets){var offset=offsets[anim],ix2=2*index;context.drawImage(image,x,y,width,height,offset[ix2+0],offset[ix2+1],width,height)}else context.drawImage(image,x,y,width,height,0,0,width,height)},_hitFunc:function(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=4*index,set=this.getAnimations()[anim],offsets=this.frameOffsets(),width=set[ix4+2],height=set[ix4+3];if(context.beginPath(),offsets){var offset=offsets[anim],ix2=2*index;context.rect(offset[ix2+0],offset[ix2+1],width,height)}else context.rect(0,0,width,height);context.closePath(),context.fillShape(this)},_useBufferCanvas:function(){return(this.hasShadow()||1!==this.getAbsoluteOpacity())&&this.hasStroke()},_setInterval:function(){var that=this;this.interval=setInterval((function(){that._updateIndex()}),1e3/this.getFrameRate())},start:function(){var layer=this.getLayer();this.anim.setLayers(layer),this._setInterval(),this.anim.start()},stop:function(){this.anim.stop(),clearInterval(this.interval)},isRunning:function(){return this.anim.isRunning()},_updateIndex:function(){var index=this.frameIndex(),animation=this.getAnimation(),animations,anim,len;index<this.getAnimations()[animation].length/4-1?this.frameIndex(index+1):this.frameIndex(0)}},Kinetic.Util.extend(Kinetic.Sprite,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"animation"),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"animations"),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"frameOffsets"),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"image"),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"frameIndex",0),Kinetic.Factory.addGetterSetter(Kinetic.Sprite,"frameRate",17),Kinetic.Factory.backCompat(Kinetic.Sprite,{index:"frameIndex",getIndex:"getFrameIndex",setIndex:"setFrameIndex"}),Kinetic.Collection.mapMethods(Kinetic.Sprite),Kinetic.Path=function(config){this.___init(config)},Kinetic.Path.prototype={___init:function(config){this.dataArray=[];var that=this;Kinetic.Shape.call(this,config),this.className="Path",this.dataArray=Kinetic.Path.parsePathData(this.getData()),this.on("dataChange.kinetic",(function(){that.dataArray=Kinetic.Path.parsePathData(this.getData())})),this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var ca=this.dataArray,closedPath=!1;context.beginPath();for(var n=0;n<ca.length;n++){var c=ca[n].command,p=ca[n].points;switch(c){case"L":context.lineTo(p[0],p[1]);break;case"M":context.moveTo(p[0],p[1]);break;case"C":context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case"Q":context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case"A":var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7],r=rx>ry?rx:ry,scaleX=rx>ry?1:rx/ry,scaleY=rx>ry?ry/rx:1;context.translate(cx,cy),context.rotate(psi),context.scale(scaleX,scaleY),context.arc(0,0,r,theta,theta+dTheta,1-fs),context.scale(1/scaleX,1/scaleY),context.rotate(-psi),context.translate(-cx,-cy);break;case"z":context.closePath(),closedPath=!0}}closedPath?context.fillStrokeShape(this):context.strokeShape(this)}},Kinetic.Util.extend(Kinetic.Path,Kinetic.Shape),Kinetic.Path.getLineLength=function(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1))},Kinetic.Path.getPointOnLine=function(dist,P1x,P1y,P2x,P2y,fromX,fromY){void 0===fromX&&(fromX=P1x),void 0===fromY&&(fromY=P1y);var m=(P2y-P1y)/(P2x-P1x+1e-8),run=Math.sqrt(dist*dist/(1+m*m));P2x<P1x&&(run*=-1);var rise=m*run,pt;if(P2x===P1x)pt={x:fromX,y:fromY+rise};else if((fromY-P1y)/(fromX-P1x+1e-8)===m)pt={x:fromX+run,y:fromY+rise};else{var ix,iy,len=this.getLineLength(P1x,P1y,P2x,P2y);if(len<1e-8)return;var u=(fromX-P1x)*(P2x-P1x)+(fromY-P1y)*(P2y-P1y);ix=P1x+(u/=len*len)*(P2x-P1x),iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy),pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt(pRun*pRun/(1+m*m)),P2x<P1x&&(run*=-1),pt={x:ix+run,y:iy+(rise=m*run)}}return pt},Kinetic.Path.getPointOnCubicBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t}function CB2(t){return 3*t*t*(1-t)}function CB3(t){return 3*t*(1-t)*(1-t)}function CB4(t){return(1-t)*(1-t)*(1-t)}var x,y;return{x:P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct),y:P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct)}},Kinetic.Path.getPointOnQuadraticBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t}function QB2(t){return 2*t*(1-t)}function QB3(t){return(1-t)*(1-t)}var x,y;return{x:P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct),y:P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct)}},Kinetic.Path.getPointOnEllipticalArc=function(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi),pt_x=rx*Math.cos(theta),pt_y=ry*Math.sin(theta);return{x:cx+(pt_x*cosPsi-pt_y*sinPsi),y:cy+(pt_x*sinPsi+pt_y*cosPsi)}},Kinetic.Path.parsePathData=function(data){if(!data)return[];var cs=data,cc=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];cs=cs.replace(new RegExp(" ","g"),",");for(var n=0;n<cc.length;n++)cs=cs.replace(new RegExp(cc[n],"g"),"|"+cc[n]);var arr=cs.split("|"),ca=[],cpx=0,cpy=0;for(n=1;n<arr.length;n++){var str=arr[n],c=str.charAt(0),p=(str=(str=(str=(str=str.slice(1)).replace(new RegExp(",-","g"),"-")).replace(new RegExp("-","g"),",-")).replace(new RegExp("e,-","g"),"e-")).split(",");p.length>0&&""===p[0]&&p.shift();for(var i=0;i<p.length;i++)p[i]=parseFloat(p[i]);for(;p.length>0&&!isNaN(p[0]);){var cmd=null,points=[],startX=cpx,startY=cpy,prevCmd,ctlPtx,ctlPty,rx,ry,psi,fa,fs,x1,y1;switch(c){case"l":cpx+=p.shift(),cpy+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"L":cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"m":var dx=p.shift(),dy=p.shift();if(cpx+=dx,cpy+=dy,cmd="M",ca.length>2&&"z"===ca[ca.length-1].command)for(var idx=ca.length-2;idx>=0;idx--)if("M"===ca[idx].command){cpx=ca[idx].points[0]+dx,cpy=ca[idx].points[1]+dy;break}points.push(cpx,cpy),c="l";break;case"M":cpx=p.shift(),cpy=p.shift(),cmd="M",points.push(cpx,cpy),c="L";break;case"h":cpx+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"H":cpx=p.shift(),cmd="L",points.push(cpx,cpy);break;case"v":cpy+=p.shift(),cmd="L",points.push(cpx,cpy);break;case"V":cpy=p.shift(),cmd="L",points.push(cpx,cpy);break;case"C":points.push(p.shift(),p.shift(),p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"c":points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="C",points.push(cpx,cpy);break;case"S":ctlPtx=cpx,ctlPty=cpy,"C"===(prevCmd=ca[ca.length-1]).command&&(ctlPtx=cpx+(cpx-prevCmd.points[2]),ctlPty=cpy+(cpy-prevCmd.points[3])),points.push(ctlPtx,ctlPty,p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),cmd="C",points.push(cpx,cpy);break;case"s":ctlPtx=cpx,ctlPty=cpy,"C"===(prevCmd=ca[ca.length-1]).command&&(ctlPtx=cpx+(cpx-prevCmd.points[2]),ctlPty=cpy+(cpy-prevCmd.points[3])),points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="C",points.push(cpx,cpy);break;case"Q":points.push(p.shift(),p.shift()),cpx=p.shift(),cpy=p.shift(),points.push(cpx,cpy);break;case"q":points.push(cpx+p.shift(),cpy+p.shift()),cpx+=p.shift(),cpy+=p.shift(),cmd="Q",points.push(cpx,cpy);break;case"T":ctlPtx=cpx,ctlPty=cpy,"Q"===(prevCmd=ca[ca.length-1]).command&&(ctlPtx=cpx+(cpx-prevCmd.points[0]),ctlPty=cpy+(cpy-prevCmd.points[1])),cpx=p.shift(),cpy=p.shift(),cmd="Q",points.push(ctlPtx,ctlPty,cpx,cpy);break;case"t":ctlPtx=cpx,ctlPty=cpy,"Q"===(prevCmd=ca[ca.length-1]).command&&(ctlPtx=cpx+(cpx-prevCmd.points[0]),ctlPty=cpy+(cpy-prevCmd.points[1])),cpx+=p.shift(),cpy+=p.shift(),cmd="Q",points.push(ctlPtx,ctlPty,cpx,cpy);break;case"A":rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift(),x1=cpx,y1=cpy,cpx=p.shift(),cpy=p.shift(),cmd="A",points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case"a":rx=p.shift(),ry=p.shift(),psi=p.shift(),fa=p.shift(),fs=p.shift(),x1=cpx,y1=cpy,cpx+=p.shift(),cpy+=p.shift(),cmd="A",points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi)}ca.push({command:cmd||c,points:points,start:{x:startX,y:startY},pathLength:this.calcLength(startX,startY,cmd||c,points)})}"z"!==c&&"Z"!==c||ca.push({command:"z",points:[],start:void 0,pathLength:0})}return ca},Kinetic.Path.calcLength=function(x,y,cmd,points){var len,p1,p2,t,path=Kinetic.Path;switch(cmd){case"L":return path.getLineLength(x,y,points[0],points[1]);case"C":for(len=0,p1=path.getPointOnCubicBezier(0,x,y,points[0],points[1],points[2],points[3],points[4],points[5]),t=.01;t<=1;t+=.01)p2=path.getPointOnCubicBezier(t,x,y,points[0],points[1],points[2],points[3],points[4],points[5]),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return len;case"Q":for(len=0,p1=path.getPointOnQuadraticBezier(0,x,y,points[0],points[1],points[2],points[3]),t=.01;t<=1;t+=.01)p2=path.getPointOnQuadraticBezier(t,x,y,points[0],points[1],points[2],points[3]),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return len;case"A":len=0;var start=points[4],dTheta=points[5],end=points[4]+dTheta,inc=Math.PI/180;if(Math.abs(start-end)<inc&&(inc=Math.abs(start-end)),p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0),dTheta<0)for(t=start-inc;t>end;t-=inc)p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;else for(t=start+inc;t<end;t+=inc)p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y),p1=p2;return p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0),len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y)}return 0},Kinetic.Path.convertEndpointToCenterParameterization=function(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180),xp=Math.cos(psi)*(x1-x2)/2+Math.sin(psi)*(y1-y2)/2,yp=-1*Math.sin(psi)*(x1-x2)/2+Math.cos(psi)*(y1-y2)/2,lambda=xp*xp/(rx*rx)+yp*yp/(ry*ry);lambda>1&&(rx*=Math.sqrt(lambda),ry*=Math.sqrt(lambda));var f=Math.sqrt((rx*rx*(ry*ry)-rx*rx*(yp*yp)-ry*ry*(xp*xp))/(rx*rx*(yp*yp)+ry*ry*(xp*xp)));fa===fs&&(f*=-1),isNaN(f)&&(f=0);var cxp=f*rx*yp/ry,cyp=f*-ry*xp/rx,cx=(x1+x2)/2+Math.cos(psi)*cxp-Math.sin(psi)*cyp,cy=(y1+y2)/2+Math.sin(psi)*cxp+Math.cos(psi)*cyp,vMag=function(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1])},vRatio=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v))},vAngle=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v))},theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]),u=[(xp-cxp)/rx,(yp-cyp)/ry],v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry],dTheta=vAngle(u,v);return vRatio(u,v)<=-1&&(dTheta=Math.PI),vRatio(u,v)>=1&&(dTheta=0),0===fs&&dTheta>0&&(dTheta-=2*Math.PI),1===fs&&dTheta<0&&(dTheta+=2*Math.PI),[cx,cy,rx,ry,theta,dTheta,psi,fs]},Kinetic.Factory.addGetterSetter(Kinetic.Path,"data"),Kinetic.Collection.mapMethods(Kinetic.Path),function(){var EMPTY_STRING="",NORMAL="normal";function _fillFunc(context){context.fillText(this.partialText,0,0)}function _strokeFunc(context){context.strokeText(this.partialText,0,0)}Kinetic.TextPath=function(config){this.___init(config)},Kinetic.TextPath.prototype={___init:function(config){var that=this;this.dummyCanvas=Kinetic.Util.createCanvasElement(),this.dataArray=[],Kinetic.Shape.call(this,config),this._fillFunc=_fillFunc,this._strokeFunc=_strokeFunc,this._fillFuncHit=_fillFunc,this._strokeFuncHit=_strokeFunc,this.className="TextPath",this.dataArray=Kinetic.Path.parsePathData(this.attrs.data),this.on("dataChange.kinetic",(function(){that.dataArray=Kinetic.Path.parsePathData(this.attrs.data)})),this.on("textChange.kinetic textStroke.kinetic textStrokeWidth.kinetic",that._setTextData),that._setTextData(),this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){context.setAttr("font",this._getContextFont()),context.setAttr("textBaseline","middle"),context.setAttr("textAlign","left"),context.save();for(var glyphInfo=this.glyphInfo,i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0;context.translate(p0.x,p0.y),context.rotate(glyphInfo[i].rotation),this.partialText=glyphInfo[i].text,context.fillStrokeShape(this),context.restore()}context.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(text){Kinetic.Text.prototype.setText.call(this,text)},_getTextSize:function(text){var dummyCanvas,_context=this.dummyCanvas.getContext("2d");_context.save(),_context.font=this._getContextFont();var metrics=_context.measureText(text);return _context.restore(),{width:metrics.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var that=this,size=this._getTextSize(this.attrs.text);this.textWidth=size.width,this.textHeight=size.height,this.glyphInfo=[];for(var charArr=this.attrs.text.split(""),p0,p1,pathCmd,pIndex=-1,currentT=0,getNextPathSegment=function(){currentT=0;for(var pathData=that.dataArray,i=pIndex+1;i<pathData.length;i++){if(pathData[i].pathLength>0)return pIndex=i,pathData[i];"M"==pathData[i].command&&(p0={x:pathData[i].points[0],y:pathData[i].points[1]})}return{}},findSegmentToFitCharacter=function(c){var glyphWidth=that._getTextSize(c).width,currLen=0,attempts=0;for(p1=void 0;Math.abs(glyphWidth-currLen)/glyphWidth>.01&&attempts<25;){attempts++;for(var cumulativePathLength=currLen;void 0===pathCmd;)(pathCmd=getNextPathSegment())&&cumulativePathLength+pathCmd.pathLength<glyphWidth&&(cumulativePathLength+=pathCmd.pathLength,pathCmd=void 0);if(pathCmd==={}||void 0===p0)return;var needNewSegment=!1;switch(pathCmd.command){case"L":Kinetic.Path.getLineLength(p0.x,p0.y,pathCmd.points[0],pathCmd.points[1])>glyphWidth?p1=Kinetic.Path.getPointOnLine(glyphWidth,p0.x,p0.y,pathCmd.points[0],pathCmd.points[1],p0.x,p0.y):pathCmd=void 0;break;case"A":var start=pathCmd.points[4],dTheta=pathCmd.points[5],end=pathCmd.points[4]+dTheta;0===currentT?currentT=start+1e-8:glyphWidth>currLen?currentT+=Math.PI/180*dTheta/Math.abs(dTheta):currentT-=Math.PI/360*dTheta/Math.abs(dTheta),(dTheta<0&&currentT<end||dTheta>=0&&currentT>end)&&(currentT=end,needNewSegment=!0),p1=Kinetic.Path.getPointOnEllipticalArc(pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],currentT,pathCmd.points[6]);break;case"C":0===currentT?currentT=glyphWidth>pathCmd.pathLength?1e-8:glyphWidth/pathCmd.pathLength:glyphWidth>currLen?currentT+=(glyphWidth-currLen)/pathCmd.pathLength:currentT-=(currLen-glyphWidth)/pathCmd.pathLength,currentT>1&&(currentT=1,needNewSegment=!0),p1=Kinetic.Path.getPointOnCubicBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],pathCmd.points[4],pathCmd.points[5]);break;case"Q":0===currentT?currentT=glyphWidth/pathCmd.pathLength:glyphWidth>currLen?currentT+=(glyphWidth-currLen)/pathCmd.pathLength:currentT-=(currLen-glyphWidth)/pathCmd.pathLength,currentT>1&&(currentT=1,needNewSegment=!0),p1=Kinetic.Path.getPointOnQuadraticBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3])}void 0!==p1&&(currLen=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y)),needNewSegment&&(needNewSegment=!1,pathCmd=void 0)}},i=0;i<charArr.length&&(findSegmentToFitCharacter(charArr[i]),void 0!==p0&&void 0!==p1);i++){var width=Kinetic.Path.getLineLength(p0.x,p0.y,p1.x,p1.y),kern=0,midpoint=Kinetic.Path.getPointOnLine(0+width/2,p0.x,p0.y,p1.x,p1.y),rotation=Math.atan2(p1.y-p0.y,p1.x-p0.x);this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:p0,p1:p1}),p0=p1}}},Kinetic.TextPath.prototype._getContextFont=Kinetic.Text.prototype._getContextFont,Kinetic.Util.extend(Kinetic.TextPath,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontFamily","Arial"),Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontSize",12),Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontStyle",NORMAL),Kinetic.Factory.addGetterSetter(Kinetic.TextPath,"fontVariant",NORMAL),Kinetic.Factory.addGetter(Kinetic.TextPath,"text",""),Kinetic.Collection.mapMethods(Kinetic.TextPath)}(),Kinetic.RegularPolygon=function(config){this.___init(config)},Kinetic.RegularPolygon.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="RegularPolygon",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var sides=this.attrs.sides,radius=this.attrs.radius,n,x,y;for(context.beginPath(),context.moveTo(0,0-radius),n=1;n<sides;n++)x=radius*Math.sin(2*n*Math.PI/sides),y=-1*radius*Math.cos(2*n*Math.PI/sides),context.lineTo(x,y);context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.RegularPolygon,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.RegularPolygon,"radius",0),Kinetic.Factory.addGetterSetter(Kinetic.RegularPolygon,"sides",0),Kinetic.Collection.mapMethods(Kinetic.RegularPolygon),Kinetic.Star=function(config){this.___init(config)},Kinetic.Star.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Star",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var innerRadius=this.innerRadius(),outerRadius=this.outerRadius(),numPoints=this.numPoints();context.beginPath(),context.moveTo(0,0-outerRadius);for(var n=1;n<2*numPoints;n++){var radius=n%2==0?outerRadius:innerRadius,x=radius*Math.sin(n*Math.PI/numPoints),y=-1*radius*Math.cos(n*Math.PI/numPoints);context.lineTo(x,y)}context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.Star,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Star,"numPoints",5),Kinetic.Factory.addGetterSetter(Kinetic.Star,"innerRadius",0),Kinetic.Factory.addGetterSetter(Kinetic.Star,"outerRadius",0),Kinetic.Collection.mapMethods(Kinetic.Star),function(){var ATTR_CHANGE_LIST=["fontFamily","fontSize","fontStyle","padding","lineHeight","text"],CHANGE_KINETIC="Change.kinetic",NONE="none",UP="up",RIGHT="right",DOWN="down",LEFT="left",LABEL="Label",attrChangeListLen=ATTR_CHANGE_LIST.length;Kinetic.Label=function(config){this.____init(config)},Kinetic.Label.prototype={____init:function(config){var that=this;Kinetic.Group.call(this,config),this.className=LABEL,this.on("add.kinetic",(function(evt){that._addListeners(evt.child),that._sync()}))},getText:function(){return this.find("Text")[0]},getTag:function(){return this.find("Tag")[0]},_addListeners:function(text){var that=this,n,func=function(){that._sync()};for(n=0;n<attrChangeListLen;n++)text.on(ATTR_CHANGE_LIST[n]+CHANGE_KINETIC,func)},getWidth:function(){return this.getText().getWidth()},getHeight:function(){return this.getText().getHeight()},_sync:function(){var text=this.getText(),tag=this.getTag(),width,height,pointerDirection,pointerWidth,x,y,pointerHeight;if(text&&tag){switch(width=text.getWidth(),height=text.getHeight(),pointerDirection=tag.getPointerDirection(),pointerWidth=tag.getPointerWidth(),pointerHeight=tag.getPointerHeight(),x=0,y=0,pointerDirection){case UP:x=width/2,y=-1*pointerHeight;break;case RIGHT:x=width+pointerWidth,y=height/2;break;case DOWN:x=width/2,y=height+pointerHeight;break;case LEFT:x=-1*pointerWidth,y=height/2}tag.setAttrs({x:-1*x,y:-1*y,width:width,height:height}),text.setAttrs({x:-1*x,y:-1*y})}}},Kinetic.Util.extend(Kinetic.Label,Kinetic.Group),Kinetic.Collection.mapMethods(Kinetic.Label),Kinetic.Tag=function(config){this.___init(config)},Kinetic.Tag.prototype={___init:function(config){Kinetic.Shape.call(this,config),this.className="Tag",this.sceneFunc(this._sceneFunc)},_sceneFunc:function(context){var width=this.getWidth(),height=this.getHeight(),pointerDirection=this.getPointerDirection(),pointerWidth=this.getPointerWidth(),pointerHeight=this.getPointerHeight(),cornerRadius=this.getCornerRadius();context.beginPath(),context.moveTo(0,0),pointerDirection===UP&&(context.lineTo((width-pointerWidth)/2,0),context.lineTo(width/2,-1*pointerHeight),context.lineTo((width+pointerWidth)/2,0)),cornerRadius?(context.lineTo(width-cornerRadius,0),context.arc(width-cornerRadius,cornerRadius,cornerRadius,3*Math.PI/2,0,!1)):context.lineTo(width,0),pointerDirection===RIGHT&&(context.lineTo(width,(height-pointerHeight)/2),context.lineTo(width+pointerWidth,height/2),context.lineTo(width,(height+pointerHeight)/2)),cornerRadius?(context.lineTo(width,height-cornerRadius),context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,!1)):context.lineTo(width,height),pointerDirection===DOWN&&(context.lineTo((width+pointerWidth)/2,height),context.lineTo(width/2,height+pointerHeight),context.lineTo((width-pointerWidth)/2,height)),cornerRadius?(context.lineTo(cornerRadius,height),context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,!1)):context.lineTo(0,height),pointerDirection===LEFT&&(context.lineTo(0,(height+pointerHeight)/2),context.lineTo(-1*pointerWidth,height/2),context.lineTo(0,(height-pointerHeight)/2)),cornerRadius&&(context.lineTo(0,cornerRadius),context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,3*Math.PI/2,!1)),context.closePath(),context.fillStrokeShape(this)}},Kinetic.Util.extend(Kinetic.Tag,Kinetic.Shape),Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerDirection",NONE),Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerWidth",0),Kinetic.Factory.addGetterSetter(Kinetic.Tag,"pointerHeight",0),Kinetic.Factory.addGetterSetter(Kinetic.Tag,"cornerRadius",0),Kinetic.Collection.mapMethods(Kinetic.Tag)}(),Kinetic.Arrow=function(config){this.____init(config)},Kinetic.Arrow.prototype={____init:function(config){Kinetic.Line.call(this,config),this.className="Arrow"},_sceneFunc:function(ctx){var PI2=2*Math.PI,points=this.points(),n=points.length,dx=points[n-2]-points[n-4],dy=points[n-1]-points[n-3],radians=(Math.atan2(dy,dx)+PI2)%PI2,length=this.pointerLength(),width=this.pointerWidth();ctx.save(),ctx.beginPath(),ctx.translate(points[n-2],points[n-1]),ctx.rotate(radians),ctx.moveTo(0,0),ctx.lineTo(-length,width/2),ctx.lineTo(-length,-width/2),ctx.closePath(),ctx.restore(),this.pointerAtBeginning()&&(ctx.save(),ctx.translate(points[0],points[1]),dx=points[2]-points[0],dy=points[3]-points[1],ctx.rotate((Math.atan2(-dy,-dx)+PI2)%PI2),ctx.moveTo(0,0),ctx.lineTo(-10,6),ctx.lineTo(-10,-6),ctx.closePath(),ctx.restore()),ctx.fillStrokeShape(this),Kinetic.Line.prototype._sceneFunc.apply(this,arguments)}},Kinetic.Util.extend(Kinetic.Arrow,Kinetic.Line),Kinetic.Factory.addGetterSetter(Kinetic.Arrow,"pointerLength",10),Kinetic.Factory.addGetterSetter(Kinetic.Arrow,"pointerWidth",10),Kinetic.Factory.addGetterSetter(Kinetic.Arrow,"pointerAtBeginning",!1),Kinetic.Collection.mapMethods(Kinetic.Arrow);